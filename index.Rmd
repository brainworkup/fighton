---
title: "Help Me Help You"
subtitle: "Neuropsychological Assessment of ADHD"
author: Joey Trampush, PhD
# author: 
#   - "Joey Trampush, PhD"
#   - "First Last, MD"
institute: 
  - "USC Keck School of Medicine"
  - "Department of Psychiatry and the Behavioral Sciences"
date: "Psychiatry Grand Rounds 2021-11-09"
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: ["assets/css/xaringan-themer.css"]
    #css: ["default", "assets/css/my-theme.css", "assets/css/my-fonts.css"]
    chakra: libs/remark-latest.min.js
    nature:
      highlightStyle: solarized-light #github
      highlightLanguage: ["r", "css", "yaml"]
      highlightLines: true
      countIncrementalSlides: false
      ratio: '16:9'
      navigation: list(click = TRUE)
      slideNumberFormat: '%current%'
      # slideNumberFormat: |
      #   <div class="progress-bar-container">
      #     <div class="progress-bar" style="width: calc(%current% / %total% * 100%);">
      #     </div>
      #   </div>      
      includePresenterNotes: yes
      countdown: 60000
      beforeInit: ["libs/macros.js"]
    self_contained: true
    anchor_sections: false
    seal: false
    includes:
      in_header: header.html        
---

```{r setup, include=FALSE}
library(knitr)
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(
  fig.path = "figs/",
  # fig.width = 9, 
  # fig.height = 3.5,
  fig.retina = 3,
  fig.asp = .5,
  out.width = "100%",
  fig.showtext = TRUE,
  comment = NULL,
  cache = FALSE,
  #cache.path = "cache/",
  #include = FALSE,
  echo = FALSE,
  message = FALSE, 
  warning = FALSE,
  dev = c("svg", "svglite"),
  hiline = TRUE
)
```

```{r xaringan-themer}
library(xaringan)
library(xaringanExtra)
library(xaringanBuilder)
library(xaringanthemer)
library(rmarkdown)
library(revealjs)
library(blogdown)
library(dataui)
library(reactable)
library(tidyverse)
library(highcharter)
library(htmlwidgets)
library(widgetframe)
library(crosstalk)
library(manipulateWidget)
library(tibble)
library(svglite)

style_mono_accent(
  base_color = "#690f0d",               # bright red
  inverse_background_color = "#002B36", # dark dark blue
  inverse_header_color = "#31b09e",     # light aqua green
  inverse_text_color = "#FFFFFF",       # white
  title_slide_background_color = "var(--base)",
  # text_font_google = google_font("Sen"),
  # header_font_google = google_font("NATS"),
  text_font_google = google_font("Kelly Slab"),
  #header_font_google = google_font("Oleo Script")
  header_font_google = google_font("Major Mono Display")
)

# for fonts
library(showtext)
# font_add_google("Bitter", "Bitter")
showtext_auto()
# theme_set(theme_minimal(base_family = "Bitter"))
# 
# # for colors
# pkg_colors <- c("palmerpenguins" = "#7899d4", 
#                 "blogdown" = "#f5ab1f", 
#                 "distill" = "#b74f6f")

```

```{r xaringan-extra, include=FALSE}
xaringanExtra::use_panelset()
xaringanExtra::use_tile_view()
xaringanExtra::use_editable(expires = 1)
xaringanExtra::use_animate_css()
xaringanExtra::use_tachyons()
xaringanExtra::use_scribble()
xaringanExtra::use_webcam()
xaringanExtra::use_clipboard()
htmltools::tagList(
  xaringanExtra::use_clipboard(
    button_text = "<i class=\"fa fa-clipboard\"></i>",
    success_text = "<i class=\"fa fa-check\" style=\"color: #90BE6D\"></i>",
    error_text = "<i class=\"fa fa-times-circle\" style=\"color: #F94144\"></i>"
  ),
  rmarkdown::html_dependency_font_awesome()
)
xaringanExtra::style_panelset_tabs(font_family = "inherit")
xaringanExtra::use_freezeframe()
xaringanExtra::use_fit_screen()
xaringanExtra::use_extra_styles(
  hover_code_line = TRUE,         #<<
  mute_unhighlighted_code = TRUE  #<<
)
xaringanExtra::use_progress_bar(color = "#478ce6", location = "top")
xaringanExtra::use_logo(
  image_url = "https://raw.githubusercontent.com/rstudio/hex-stickers/master/PNG/xaringan.png"
)
```

```{r share-again, eval=FALSE}
xaringanExtra::use_share_again()
xaringanExtra::style_share_again(
  share_buttons = c("twitter", "instagram")
)
xaringanExtra::embed_xaringan(url = "https://brainworkup.github.io/fighton/", ratio = "16:9")
```

```{r broadcast}
xaringanExtra::use_broadcast()
```

class: title-slide, left, middle
background-image: url("images/daftpunktocat-thomas.gif")
background-position: right
background-size: contain
background-color: #7899d4ff

.pull-left[

# `r rmarkdown::metadata$title`

## `r rmarkdown::metadata$subtitle`

### `r rmarkdown::metadata$author`

### `r rmarkdown::metadata$date`
]

---
class: middle, center, inverse

# .big-text[Hello.]

???

So hello- I'm so happy to be invited to join you all today.

---

.bg-washed-green.b--dark-green.ba.bw2.br3.shadow-5.ph4.mt5[
If you cannot explain something in simple terms, you don't understand it.

.tr[
— Richard Feynman
]]

.center[![jerry maguire](images/jerry_maguire.gif)]

---

# Data science

.center[![data-science](images/computer.gif)]

---
class: inverse center middle

# 80HD

## Child ADHD

.pull-right[
![:scale 25%](images/dinotocat.png)
]

---
class: inverse center middle

# 80HD

## Adult ADHD

---

# neuropsychological deficits related to adhd

.left-column[
### Working Memory

### Processing Speed

### Response Variability
]

.right-column[
Remembering things short term memory.
Rate of test taking, rate of speed of information processing.
Reaction time variability/response consistency.

Remembering things short term memory.
Rate of test taking, rate of speed of information processing.
Reaction time variability/response consistency.

Remembering things short term memory.
Rate of test taking, rate of speed of information processing.
Reaction time variability/response consistency.

]

---
class: middle center animated slideInRight fadeOutLeft

## Distribution of Scores: _Population-level Interpretation_

```{r gauss-plot1, fig.cap='Statistical classification of neuropsychological test scores in the general population.', fig.width=4, fig.height=4, out.width = "50%"}
knitr::include_graphics("images/plot_narrow.png", auto_pdf = TRUE)
```

---
class: middle center animated slideInLeft fadeOutRight 

## Distribution of Scores: _Clinical Interpretation_

```{r gauss-plot2, fig.cap='General clinical interpretation of performance for individual test scores and broader neuropsychological domains.', fig.retina=3, fig.asp=0.5, out.width = "50%"}
# change these to match if necessary
knitr::include_graphics("images/plot_broad.png", auto_pdf = TRUE)
```

---

## Highcharter Drilldown: z-Scores (M = 0, SD = 1)

```{r}
patient <- "Biggie"
```

```{r drillz-data}
library(readr)
library(dplyr)
neurocog <- read_csv("neurocog.csv")
```

```{r}
library(highcharter)
library(tidyverse)
library(htmlwidgets)
library(widgetframe)
library(crosstalk)
library(manipulateWidget)
colors <-
  c(
    "#058DC7",
    "#50B432",
    "#ED561B",
    "#DDDF00",
    "#24CBE5",
    "#64E572"
# "#FF9655",
# "#FFF263",
# "#6AF9C4"
  )
```

```{r drillz-data-tidy}
ncogz <- neurocog %>%
  group_by(domain) %>%
  summarize(zMean = mean(z)
  )
ncogz <- arrange(ncogz, desc(zMean))

## Level 1
ncogL1statusz <- tibble(
  name = ncogz$domain,
  y = ncogz$zMean,
  drilldown = tolower(name)
  )
ncogL1statusz$y <- round(ncogL1statusz$y, 1)

## Level 2
ncogL2drillz <- lapply(unique(neurocog$domain), function(x_level) {
  ncog2z <- subset(neurocog, neurocog$domain %in% x_level)
  ncog2z <- ncog2z %>%
    group_by(subdomain) %>%
    summarize(zMean = mean(z))
  ncog2z <- arrange(ncog2z, desc(zMean)) ### CHECK
  ncogL2zstatus <- tibble(name = ncog2z$subdomain, y = ncog2z$zMean, drilldown = tolower(paste(x_level, name, sep = "_")))
  list(id = tolower(x_level), type = "column", data = list_parse(ncogL2zstatus))
})

## Level 3
ncogL3drillz <- lapply(unique(neurocog$domain), function(x_level) {
  ncog2z <- subset(neurocog, neurocog$domain %in% x_level)
  lapply(unique(ncog2z$subdomain), function(y_level) {
    ncog3z <- subset(ncog2z, ncog2z$subdomain %in% y_level)
    # ncog3 <- ncog2[ncog2$subdomain == y_level,]
    ncog3z <- ncog3z %>%
      group_by(narrow) %>%
      summarize(zMean = mean(z))
    ncog3z <- arrange(ncog3z, desc(zMean))
    ncogL3zstatus <- tibble(name = ncog3z$narrow, y = ncog3z$zMean, drilldown = tolower(paste(x_level, y_level, name, sep = "_")))
    list(id = tolower(paste(x_level, y_level, sep = "_")), type = "column", data = list_parse(ncogL3zstatus))
  })
}) %>% unlist(recursive = FALSE)

## Level 4
ncogL4drillz <- lapply(unique(neurocog$domain), function(x_level) {
  ncog2z <- subset(neurocog, neurocog$domain %in% x_level)
  # ncog2 <- neurocog[neurocog$domain == x_level,]
  lapply(unique(ncog2z$subdomain), function(y_level) {
    ncog3z <- subset(ncog2z, ncog2z$subdomain %in% y_level)
    # ncog3 <- ncog2[ncog2$subdomain == y_level,]
    lapply(unique(ncog3z$narrow), function(z_level) {
      ncog4z <- subset(ncog3z, ncog3z$narrow %in% z_level)
      # ncog4 <- ncog3[ncog3$narrow == z_level,]
      ncog4z <- ncog4z %>%
        group_by(scale) %>%
        summarize(zMean = mean(z))
      ncog4z <- arrange(ncog4z, desc(zMean))
      ncogL4zstatus <- tibble(name = ncog4z$scale, y = ncog4z$zMean)
      list(id = tolower(paste(x_level, y_level, z_level, sep = "_")), type = "column", data = list_parse2(ncogL4zstatus))
    })
  }) %>% unlist(recursive = FALSE)
}) %>% unlist(recursive = FALSE)
```

```{r drillz-tt}
ncogL1statusz <- ncogL1statusz %>%
  dplyr::mutate(
    rangez = case_when(
      y >= 2.0 ~ "Exceptionally High",
      y %in% 1.3:1.9 ~ "Above Average",
      y %in% 0.7:1.2 ~ "High-Average",
      y %in% -0.7:0.6 ~ "Average",
      y %in% -1.3:-0.6 ~ "Low-Average",
      y %in% -2.0:-1.4 ~ "Below Average",
      y < -2.0 ~ "Exceptionally Low"
    )
  )
x <- c("Name", "Score", "Range")
y <- c("{point.name}", "{point.y}", "{point.rangez}")
tt <- tooltip_table(x, y)
```

```{r drillz-plot, fig.width=12, fig.height=8, fig.retina=3, out.width = "100%"}
p1 <-
  highchart() %>%
    hc_title(text = patient, style = list(fontSize = "15px")) %>%
    hc_add_series(
      ncogL1statusz,
      type = "bar",
      name = "Neuropsychological Test Scores",
      hcaes(x = name, y = y, color = colors)
    ) %>%
    hc_xAxis(
      type = "category",
      title = list(text = "Domain"),
      categories = .$name
    ) %>%
    hc_yAxis(
      title = list(text = "z-score"),
      labels = list(format = "{value}")
    ) %>%
    hc_tooltip(
      pointFormat = tt,
      useHTML = TRUE,
      valueDecimals = 1
    ) %>%
    hc_plotOptions(
      series = list(
        colorByPoint = TRUE,
        allowPointSelect = TRUE,
        dataLabels = TRUE
      )
    ) %>%
    hc_drilldown(
      allowPointDrilldown = TRUE,
      series = c(ncogL2drillz, ncogL3drillz, ncogL4drillz)
    )
p1
```

---

## Neuropsych Drilldown: Percentiles

```{r drillp-tidy}
# percentiles
ncog <- neurocog %>%
  group_by(domain) %>%
  summarize(Pct = mean(percentile)
  )

ncog <- arrange(ncog, desc(Pct))

## Level 1
ncogL1status <- tibble(
  name = ncog$domain,
  y = as.integer(ncog$Pct),
  drilldown = tolower(name))
# ncogL1status$y <- as.integer(ncogL1status$y)

## Level 2
ncogL2drill <- lapply(unique(neurocog$domain), function(x_level) {
  ncog2 <- subset(neurocog, neurocog$domain %in% x_level)
  # ncog2 <- neurocog[neurocog$domain == x_level,]
  ncog2 <- ncog2 %>%
    group_by(subdomain) %>%
    summarize(Pct = mean(percentile))
  ncog2 <- arrange(ncog2, desc(Pct)) ### CHECK
  ncogL2status <- tibble(name = ncog2$subdomain, y = ncog2$Pct, drilldown = tolower(paste(x_level, name, sep = "_")))
  list(id = tolower(x_level), type = "column", data = list_parse(ncogL2status))
})

## Level 3
ncogL3drill <- lapply(unique(neurocog$domain), function(x_level) {
  ncog2 <- subset(neurocog, neurocog$domain %in% x_level)
  # ncog2 <- neurocog[neurocog$domain == x_level,]
  lapply(unique(ncog2$subdomain), function(y_level) {
    ncog3 <- subset(ncog2, ncog2$subdomain %in% y_level)
    # ncog3 <- ncog2[ncog2$subdomain == y_level,]
    ncog3 <- ncog3 %>%
      group_by(narrow) %>%
      summarize(Pct = mean(percentile))
    ncog3 <- arrange(ncog3, desc(Pct))
    ncogL3status <- tibble(name = ncog3$narrow, y = ncog3$Pct, drilldown = tolower(paste(x_level, y_level, name, sep = "_")))
    list(id = tolower(paste(x_level, y_level, sep = "_")), type = "column", data = list_parse(ncogL3status))
  })
}) %>% unlist(recursive = FALSE)

## Level 4
ncogL4drill <- lapply(unique(neurocog$domain), function(x_level) {
  ncog2 <- subset(neurocog, neurocog$domain %in% x_level)
  # ncog2 <- neurocog[neurocog$domain == x_level,]
  lapply(unique(ncog2$subdomain), function(y_level) {
    ncog3 <- subset(ncog2, ncog2$subdomain %in% y_level)
    # ncog3 <- ncog2[ncog2$subdomain == y_level,]
    lapply(unique(ncog3$narrow), function(z_level) {
      ncog4 <- subset(ncog3, ncog3$narrow %in% z_level)
      # ncog4 <- ncog3[ncog3$narrow == z_level,]
      ncog4 <- ncog4 %>%
        group_by(scale) %>%
        summarize(Pct = mean(percentile))
      ncog4 <- arrange(ncog4, desc(Pct))
      ncogL4status <- tibble(name = ncog4$scale, y = ncog4$Pct)
      list(id = tolower(paste(x_level, y_level, z_level, sep = "_")), type = "column", data = list_parse2(ncogL4status))
    })
  }) %>% unlist(recursive = FALSE)
}) %>% unlist(recursive = FALSE)
```


```{r drillp-tt}
## for Tooltip
ncogL1status <- ncogL1status %>%
  dplyr::mutate(
    rangep = case_when(
      y >= 98 ~ "Exceptionally High",
      y %in% 91:97 ~ "Above Average",
      y %in% 75:90 ~ "High-Average",
      y %in% 25:74 ~ "Average",
      y %in% 9:24 ~ "Low-Average",
      y %in% 2:8 ~ "Below Average",
      y < 2 ~ "Exceptionally Low",
      TRUE ~ as.character(y)
    )
  )
x <- c("Name", "Score", "Range")
y <- c("{point.name}", "{point.y}", "{point.rangep}")
tt <- tooltip_table(x, y)
```

```{r drillp-plot, fig.retina=3, fig.asp=0.5, out.width = "100%"}
p2 <- 
  highchart() %>%
  hc_title(text = patient,
           style = list(fontSize = "15px")) %>%
  hc_add_series(
    ncogL1status,
    type = "bar",
    name = "Neuropsychological Test Scores",
    hcaes(x = name, y = y, color = colors)
  ) %>%
  hc_xAxis(
    type = "category",
    title = list(text = "Domain"),
    categories = .$name
  ) %>%
  hc_yAxis(
    title = list(text = "Percentile"),
    labels = list(format = "{value} ‰")
  ) %>%
  hc_tooltip(
    pointFormat = tt,
    useHTML = TRUE,
    valueDecimals = 0
  ) %>%
  hc_plotOptions(
    series = list(
      colorByPoint = TRUE,
      allowPointSelect = TRUE,
      dataLabels = TRUE
    )
  ) %>%
  hc_drilldown(
    allowPointDrilldown = TRUE,
    series = c(ncogL2drill, ncogL3drill, ncogL4drill)
  )
p2
```

---

# R `dataui` package 

```{r}
library(dataui)
library(reactable)
```

```{r}
# this is a very ugly way of creating a data.frame with lists
df1 <- data.frame(
  Group = LETTERS[1:5],
  Line =- NA,
  Bar = NA,
  stringsAsFactors = FALSE
)
df1$Line <- lapply(1:5, function(x) list(runif(30)))
df1$Bar <- lapply(1:5, function(x) list(rnorm(40, mean = x, sd = 2)))

# to use same x scale we will calculate bins and use later
bins <- hist(unlist(df1$Bar), breaks = 20, plot = FALSE)$breaks

rt1 <- reactable(
  df1,
  columns = list(
    Line = colDef(
      # use reactable very convenient conversion of htmlwidgets
      #  we will focus on this in another article
      #  more details on custom rendering
      #  https://glin.github.io/reactable/articles/custom-rendering.html
      cell = function(value, index) {
        dui_sparkline(
          data = value[[1]], # because we gave it a list use [[1]]
          height = 80, # we will want to be specific here
          components = dui_sparklineseries()
        )
      }
    ),
    Bar = colDef(
      cell = function(value, index) {
        dui_sparkline(
          data = hist(value[[1]], breaks=bins, plot=FALSE)$density,
          height = 80,
          component = dui_sparkbarseries()
        )
      }
    )
  )
)
rt1
```

```{r xaringan-themer, include=FALSE, warning=FALSE}
library(xaringanthemer)
style_mono_accent(
  base_color = "#DC322F",               # bright red
  inverse_background_color = "#002B36", # dark dark blue
  inverse_header_color = "#31b09e",     # light aqua green
  inverse_text_color = "#FFFFFF",       # white
  title_slide_background_color = "var(--base)",
  text_font_google = google_font("Kelly Slab"),
  header_font_google = google_font("Oleo Script")
)
```

```{r xaringan-themer1, include=FALSE, warning=FALSE}
library(xaringanthemer)
mono <- tempfile("mono-", fileext = ".css")
style_mono_accent(
  base_color = "#DC322F",               # bright red
  inverse_background_color = "#002B36", # dark dark blue
  inverse_header_color = "#31b09e",     # light aqua green
  inverse_text_color = "#FFFFFF",       # white
  title_slide_background_color = "var(--base)",
  text_font_google = google_font("Kelly Slab"),
  header_font_google = google_font("Oleo Script"),
  outfile = mono
)
#file.edit(mono)
```

---


```{r}
library(ggplot2)
g_base <- ggplot(mpg) + 
  aes(hwy, cty) + 
  geom_point() +
  labs(x = "Highway MPG", y = "City MPG", title = "Fuel Efficiency")
# Basic plot with default theme
g_base
```
---

## Plots

```{r}
# Fancy slide-matching themed plot
g_base + theme_xaringan()
```

---

```{r}
theme_xaringan_restore_defaults()
```

```{r}
# theme_xaringan() on the left, theme_xaringan_inverse() on the right
g_base + theme_xaringan_inverse()
```

```{r}
theme_xaringan(css_file = "assets/css/mono-jwt.css")
```

```{r}
theme_xaringan(
  text_color = "#3D3E38",
  background_color = "#FFFFFF",
  accent_color = "#DC322F",
  text_font = "Apex",
  text_font_use_google = TRUE,
  title_font = "Oleo Script",
  title_font_use_google = TRUE
)
```

---

```{r}
g_diamonds <- ggplot(diamonds, aes(x = cut)) +
  geom_bar() +
  labs(x = NULL, y = NULL, title = "Diamond Cut Quality") +
  ylim(0, 25000)
g_diamonds + theme_xaringan()
```

```{r}
theme_xaringan_restore_defaults()
```

---

## Alpha

```{r}
ggplot(diamonds, aes(x = cut)) +
  geom_bar(aes(fill = ..count..), show.legend = FALSE) +
  labs(x = NULL, y = "Count", title = "Diamond Cut Quality") +
  theme_xaringan() +
  scale_xaringan_fill_continuous()
# ggplot(mpg, aes(x = hwy, y = cty)) +
#   geom_count(aes(color = ..n..), show.legend = FALSE) +
#   labs(x = "Highway MPG", y = "City MPG", title = "Fuel Efficiency") +
#   theme_xaringan_inverse() +
#   scale_xaringan_color_continuous(breaks = seq(3, 12, 2), inverse = TRUE, begin = 1, end = 0)
```

---

## with values
```{r}
g_diamonds_with_text <- 
  g_diamonds + 
  geom_text(aes(y = ..count.., label = format(..count.., big.mark = ",")),
            vjust = -0.30, size = 8, stat = "count") +
  labs(x = "Cut", y = "Count")
g_diamonds_with_text + theme_xaringan()
```

---

## Hollywood font

```{r}
g_diamonds_with_text +
  theme_xaringan(
    text_font = google_font("Ranga"),
    title_font = google_font("Holtwood One SC")
  )
```

---

## GlacialIndifference Font

```{r, eval=F}
style_mono_accent(
  text_font_family = "GlacialIndifferenceRegular",
  text_font_url = "https://fontlibrary.org/face/glacial-indifference"
)
```

```{r, eval=FALSE}
font_url <- file.path(
  "https://fontlibrary.org/assets/fonts/glacial-indifference/",
  "5f2cf277506e19ec77729122f27b1faf/0820b3c58fed35de298219f314635982", 
  "GlacialIndifferenceRegular.ttf"
)
font_temp <- tempfile()
download.file(font_url, font_temp)
```


```{r, eval=FALSE}
# Path to the local custom font file
font_temp <- system.file(
  "fonts/GlacialIndifferenceRegular.ttf", package = "xaringanthemer"
)

# Register the font with sysfonts/showtext
sysfonts::font_add(family = "GlacialIndifferenceRegular", regular = font_temp)

# Now it's available for use!
g_diamonds_with_text +
  theme_xaringan(
    text_font = "GlacialIndifferenceRegular",
    title_font = "GlacialIndifferenceRegular"
  )
```

---

```{r, sirf, results='asis'}
cat("---\n")
cat(readLines('sirf.md'), sep = '\n')
```

---
class: left

# Thanks!

.bg-washed-green.b--dark-green.ba.bw2.br3.shadow-5.ph4.mt5[
When something is important enough, 
you do it even if the odds are not in your favor.

.tr[
— Someone
]]

![:scale 25%](images/my-octocat.png)

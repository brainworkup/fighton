---
title: "A.D.H.D."
subtitle: "Neuropsychological assessment for diagnostic clarification and treatment planning"
author1: 
  - "Joey W. Trampush, Ph.D."
  - "Della Martin Assistant Professor of Psychiatry"  
author2:
  - "Ashraf Elmashat, M.D."
  - "Professor of Psychiatry"
institute: 
  - "Department of Psychiatry and the Behavioral Sciences"
  - "USC Keck School of Medicine"
date: "2021-12-21"
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: ["default", "assets/css/fighton-fonts.css", "assets/css/fighton-theme.css"]
    chakra: libs/remark-latest.min.js
    nature:
      highlightStyle: monokai
      highlightLanguage: ["r", "css", "yaml"]
      highlightLines: true
      countIncrementalSlides: true
      ratio: '16:9'
      navigation: list(click = true)
      slideNumberFormat: |
        <div class="progress-bar-container">
          <div class="progress-bar" style="width: calc(%current% / %total% * 100%);">
          </div>
        </div>
      includePresenterNotes: yes
      countdown: 60000
      beforeInit: ["libs/macros.js"]
    self_contained: false
    anchor_sections: false
    seal: false
    includes:
      in_header: header.html        
---

```{r setup, include=FALSE}
## load libraries
library(knitr)
library(xaringan)
library(xaringanExtra)
library(xaringanBuilder)
library(xaringanthemer)
library(rmarkdown)
library(revealjs)
library(blogdown)
library(dataui)
library(reactable)
library(tidyverse)
library(highcharter)
library(htmlwidgets)
library(widgetframe)
library(crosstalk)
library(manipulateWidget)
library(tibble)
library(svglite)
library(gifski)

## knitr options
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(
  fig.path = "figs/",
  fig.width = 12,
  fig.height = 4,
  fig.asp = .5, # might not work
  fig.retina = 3,
  out.width = "100%",
  fig.showtext = TRUE,
  comment = NULL,
  cache = FALSE,
  cache.path = "cache/",
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  dev = c("svg", "svglite"),
  hiline = TRUE
)
```

```{r xaringan-extra, include=F}
xaringanExtra::use_animate_css()
# xaringanExtra::embed_xaringan("https://brainworkup.github.io/fighton/")
xaringanExtra::use_tachyons()
xaringanExtra::use_tile_view()
xaringanExtra::use_broadcast()
xaringanExtra::use_scribble()
xaringanExtra::use_panelset()
xaringanExtra::use_webcam()
xaringanExtra::style_panelset_tabs(font_family = "inherit")
xaringanExtra::use_freezeframe()
xaringanExtra::use_fit_screen()
xaringanExtra::use_extra_styles(
  hover_code_line = TRUE, #<<
  mute_unhighlighted_code = TRUE #<<
)
xaringanExtra::use_share_again()
```

name: title
class: title-slide, left, middle
background-image: url(images/daftpunktocat-thomas.gif)
background-position: right
background-size: contain
background-color: #990000

.pull-left[
# `r rmarkdown::metadata$title`
## `r rmarkdown::metadata$subtitle`
### `r rmarkdown::metadata$author1`
### `r rmarkdown::metadata$author2`
### `r rmarkdown::metadata$institute`
### `r rmarkdown::metadata$date`
]

---
class: middle, center

## .big-text[Hello.]

???

Our department has grown since 2018

---

class: middle, center
color: var(--red)

.bg-washed-green.b--dark-green.ba.bw2.br3.shadow-5.ph4.mt5[
If you cannot explain something in simple terms, you don't understand it.

.tr[
â€” Richard Feynman
]]

.center[![:scale 45%](images/jerry_maguire.gif)]

---
<!-- class: middle -->
<!-- type: exclaim -->
class: flex

What do I know about .big[ADHD]?

.right.middle[![:scale 35%](images/dinotocat.png)]

[`r fontawesome::fa("github")` @brainworkup](https://github.com/brainworkup)
[`r fontawesome::fa("twitter")` @brainworkup](https://twitter.com/brainworkup)   
[`r fontawesome::fa("link")` brainworkup.io](https://brainworkup.io)

???

80HD
PATS preschool study

---

class: middle, left

## Data Science

.left[

![:scale 45%](images/computer.gif)

]

---

class: center middle

.big[1.]
## inattention

---

class: center middle

.big[2.]
## hyperactivity

---

class: center middle

.big[3.]
## impulsivity

---

class: center middle

.big[4.]
## working memory

---

class: center middle

.big[5.]
## stimulus boundness

---

class: section, middle

.left[Left hand side content]

.center[Middle content]

.right[Right hand side content]

---

class: section middle center

## Clinical ADHD vs Cognitive ADHD

.pull-left[
### inattention
### hyperactivity
### impulsivity
]

.pull-right[
### working memory
### response variability
### stimulus boundness
]


---
class: inverse, middle

### Neurocognitive deficits related to adhd

.panelset[
.panel[.panel-name[Working Memory]

#### Working Memory

- Remembering things short term memory

- Verbal information

- Nonverbal information

- "mind's eye"
]

.panel[.panel-name[Processing Speed]

#### Processing Speed

- Rate of test taking

- Rate of speed of information processing

- Some other description

- Fourth layer

]

.panel[.panel-name[Response Variability]

#### Response Variability

- Reaction time variability

- Response consistency

- Attentional drift

- Impulsive responding

]

.panel[.panel-name[Inhibitory Control]

#### Inhibitory Control

- Go/No-Go performance

- Core DSM symptom (impulsivity)

- Something else ...

- Impulsive responding

]
]

---
name: bell
class: left, middle, fullscale
background-image: url(https://gifs.joelglovier.com/crying/laughing-crying.gif)
background-position: 50% 50%
background-size: 100%

#### Emotional Control

.pull-left[
> **Emotion** `r emo::ji("fire")`
>
> **(Dys)Regulation**
> 
> in **ADHD**
>
> Not part of DSM/ICD diagnostic criteria 
>
> .big[BUT] ...
>
]

???

This is recognized on most rating scales e.g., brown

---
class: middle, center

.frame[
### Read these words as fast as you can
]

---
class: middle, center

.frame[
### RED
]

.frame[
### GREEN
]

.frame[
### BLUE 
]

.frame[
### YELLOW


]

???

This is how we test it

---
class: middle, center

.frame[
### .red[RED]
]

.frame[
### .green[GREEN]
]

.frame[
### .blue[BLUE] 
]

.frame[
### .yellow[YELLOW]
]

???

Also how

---
class: middle, center

.frame[
### .purple[RED]
### .orange[GREEN]
### .pink[BLUE] 
### .green[YELLOW]
]

???

This is how we test it

---
name: agenda
class: middle, center

## Agenda

The .blue[name] of this slide is {{ name }}.

---
name: gauss1
class: middle center inverse animated slideInRight fadeOutLeft
background-color: #FFFFFF
background-size: auto

## Distribution of Scores: _Population-level Interpretation_

```{r gauss-plot1, fig.cap='Statistical classification of neuropsychological test scores in the general population.', fig.retina=3, fig.asp=0.5, out.width = '50%'}
knitr::include_graphics("images/plot_narrow.png", auto_pdf = TRUE)
```

---

name: gauss2
class: middle center inverse animated slideInLeft fadeOutRight 
background-color: #FFFFFF
background-size: auto

## Distribution of Scores: _Clinical Interpretation_

```{r gauss-plot2, fig.cap='General clinical interpretation of performance for individual test scores and broader neuropsychological domains.', fig.retina=3, fig.asp=0.5, out.width = '50%'}
# change these to match if necessary
knitr::include_graphics("images/plot_broad.png", auto_pdf = TRUE)
```

---

## Cognitive Data

```{r patient}
patient <- "Simone"
```

```{r echo=FALSE}
library(highcharter)
library(tidyverse)
library(htmlwidgets)
library(widgetframe)
```

```{r read-csv}
data_path <- here::here(patient, "csv")
files <- dir(data_path, pattern = "*.csv")
neuropsych <-
  files %>%
  set_names() %>%
  map_df(
    ~ readr::read_csv(file.path(data_path, .), show_col_types = FALSE),
    na = c("", "NA", "--", "-"),
    .id = "filename"
  ) %>%
  filter(!is.na(percentile)) %>%
  distinct() %>%
  mutate(z = qnorm(percentile / 100)) %>%
  mutate(domain = forcats::as_factor(domain)) %>%
  mutate(subdomain = forcats::as_factor(subdomain)) %>%
  mutate(narrow = forcats::as_factor(narrow)) %>%
  mutate(pass = forcats::as_factor(pass)) %>%
  mutate(verbal = forcats::as_factor(verbal)) %>%
  mutate(timed = forcats::as_factor(timed))
```

```{r, make-factors-neurocog}
# Subset neurocognitive data
neurocog <-
  neuropsych %>%
  filter(test_type == "npsych_test")
# domain
neurocog <-
  neurocog %>%
  group_by(domain, .add = TRUE) %>%
  filter(!is.na(percentile)) %>%
  mutate(z_mean_dom = mean(z), z_sd_dom = sd(z)) %>%
  mutate(
    pct_mean_dom = mean(percentile),
    pct_sd_dom = sd(percentile)
  ) %>%
  ungroup()
# subdomain
neurocog <-
  neurocog %>%
  group_by(subdomain, .add = TRUE) %>%
  filter(!is.na(percentile)) %>%
  mutate(z_mean_sub = mean(z), z_sd_sub = sd(z)) %>%
  mutate(
    pct_mean_sub = mean(percentile),
    pct_sd_sub = sd(percentile)
  ) %>%
  ungroup()
# narrow
neurocog <-
  neurocog %>%
  group_by(narrow, .add = TRUE) %>%
  filter(!is.na(percentile)) %>%
  mutate(z_mean_narrow = mean(z), z_sd_narrow = sd(z)) %>%
  mutate(
    pct_mean_narrow = mean(percentile),
    pct_sd_narrow = sd(percentile)
  ) %>%
  ungroup()
# pass
neurocog <-
  neurocog %>%
  group_by(pass, .add = TRUE) %>%
  filter(!is.na(percentile)) %>%
  mutate(z_mean_pass = mean(z), z_sd_pass = sd(z)) %>%
  ungroup()
# verbal
neurocog <-
  neurocog %>%
  group_by(verbal, .add = TRUE) %>%
  filter(!is.na(percentile)) %>%
  mutate(z_mean_verbal = mean(z), z_sd_verbal = sd(z)) %>%
  ungroup()
# timed
neurocog <-
  neurocog %>%
  group_by(timed, .add = TRUE) %>%
  filter(!is.na(percentile)) %>%
  mutate(z_mean_timed = mean(z), z_sd_timed = sd(z)) %>%
  ungroup()
# result text
neurocog <-
  neurocog %>%
  dplyr::mutate(
    result = glue::glue(
      "{patient}'s score on {scale}, a measure of {description}, fell in the *{range}* range (PR = {percentile})."
    )
  )
```

```{r, make-factors-neurobehav}
# Subset neurobehavioral data
neurobehav <-
  neuropsych %>%
  filter(test_type != "npsych_test")
# domain
neurobehav <-
  neurobehav %>%
  group_by(domain, .add = TRUE) %>%
  filter(!is.na(score)) %>%
  mutate(z_mean_dom = mean(z), z_sd_dom = sd(z)) %>%
  mutate(
    pct_mean_dom = mean(percentile),
    pct_sd_dom = sd(percentile)
  ) %>%
  ungroup()
# subdomain
neurobehav <-
  neurobehav %>%
  group_by(subdomain, .add = TRUE) %>%
  filter(!is.na(score)) %>%
  mutate(z_mean_sub = mean(z), z_sd_sub = sd(z)) %>%
  mutate(
    pct_mean_sub = mean(percentile),
    pct_sd_sub = sd(percentile)
  ) %>%
  ungroup()
# narrow
neurobehav <-
  neurobehav %>%
  group_by(narrow, .add = TRUE) %>%
  filter(!is.na(score)) %>%
  mutate(z_mean_narrow = mean(z), z_sd_narrow = sd(z)) %>%
  mutate(
    pct_mean_narrow = mean(percentile),
    pct_sd_narrow = sd(percentile)
  ) %>%
  ungroup()
# result text
neurobehav <-
  neurobehav %>%
  dplyr::mutate(
    result = glue::glue(
      "{patient}'s score on {scale}, a measure of {description}, fell in the *{range}* range (PR = {percentile})."
    )
  )
```

```{r, write-data}
readr::write_csv(neuropsych, here::here(patient, "neuropsych.csv"))
readr::write_csv(neurocog, here::here(patient, "neurocog.csv"))
readr::write_csv(neurobehav, here::here(patient, "neurobehav.csv"))
```

```{r, read-data}
neuropsych <-
  readr::read_csv(here::here(patient, "neuropsych.csv"), show_col_types = FALSE)
neurocog <-
  readr::read_csv(here::here(patient, "neurocog.csv"), show_col_types = FALSE)
neurobehav <-
  readr::read_csv(here::here(patient, "neurobehav.csv"), show_col_types = FALSE)
```

```{r drilldown-level1}
## Level 1
## Domain scores
# 1. create mean z-scores for domain
ncog1 <- neurocog %>%
  dplyr::group_by(domain) %>%
  dplyr::summarize(zMean = mean(z),
                   zPct = mean(percentile)) %>%
  dplyr::mutate(range = NA)
ncog1$zMean <- round(ncog1$zMean, 2L)
ncog1$zPct <- round(ncog1$zPct, 0L)
ncog1 <-
  ncog1 %>%
  dplyr::mutate(
    range = dplyr::case_when(
      zPct >= 98 ~ "Exceptionally High",
      zPct %in% 91:97 ~ "Above Average",
      zPct %in% 75:90 ~ "High-Average",
      zPct %in% 25:74 ~ "Average",
      zPct %in% 9:24 ~ "Low-Average",
      zPct %in% 2:8 ~ "Below Average",
      zPct < 2 ~ "Exceptionally Low",
      TRUE ~ as.character(range)
    )
  )

# 2. sort hi to lo
ncog1 <- arrange(ncog1, desc(zMean))

# 3. create tibble with new column with domain name lowercase
ncog_level1_status <- tibble(
  name = ncog1$domain,
  y = ncog1$zMean,
  y2 = ncog1$zPct,
  range = ncog1$range,
  drilldown = tolower(name)
)
```

```{r drilldown-level2}
## Level 2
## Subdomain scores
## function to create second level of drilldown (subdomain scores)
ncog_level2_drill <-
  lapply(unique(neurocog$domain), function(x_level) {
    ncog2 <- subset(neurocog, neurocog$domain %in% x_level)
    
    # same as above
    ncog2 <-
      ncog2 %>%
      group_by(subdomain) %>%
      summarize(zMean = mean(z),
                zPct = mean(percentile)) %>%
      mutate(range = NA)
    
    # round z-score to 1 decimal
    ncog2$zMean <- round(ncog2$zMean, 2L)
    ncog2$zPct <- round(ncog2$zPct, 0L)
    ncog2 <-
      ncog2 %>%
      dplyr::mutate(
        range = dplyr::case_when(
          zPct >= 98 ~ "Exceptionally High",
          zPct %in% 91:97 ~ "Above Average",
          zPct %in% 75:90 ~ "High-Average",
          zPct %in% 25:74 ~ "Average",
          zPct %in% 9:24 ~ "Low-Average",
          zPct %in% 2:8 ~ "Below Average",
          zPct < 2 ~ "Exceptionally Low",
          TRUE ~ as.character(range)
        )
      )
    
    # 2. sort hi to lo
    ncog2 <- arrange(ncog2, desc(zMean))
    
    # 3. create tibble with new column with domain name lowercase
    ncog_level2_status <- tibble(
      name = ncog2$subdomain,
      y = ncog2$zMean,
      y2 = ncog2$zPct,
      range = ncog2$range,
      drilldown = tolower(paste(x_level, name, sep = "_"))
    )
    
    list(
      id = tolower(x_level),
      type = "column",
      data = list_parse(ncog_level2_status)
    )
  })
```

```{r drilldown-level3}
## Level 3
## Narrow subdomains
## reuse function
ncog_level3_drill <-
  lapply(unique(neurocog$domain), function(x_level) {
    ncog2 <- subset(neurocog, neurocog$domain %in% x_level)
    
    # reuse function but with y_level
    lapply(unique(ncog2$subdomain), function(y_level) {
      # 1. create mean z-scores for subdomain
      # ncog3 becomes pronoun for domain
      ncog3 <- subset(ncog2, ncog2$subdomain %in% y_level)
      
      ncog3 <- ncog3 %>%
        group_by(narrow) %>%
        summarize(zMean = mean(z), zPct = mean(percentile)) %>%
        mutate(range = NA)
      
      # round z-score to 1 decimal
      ncog3$zMean <- round(ncog3$zMean, 2L)
      ncog3$zPct <- round(ncog3$zPct, 0L)
      ncog3 <-
        ncog3 %>%
        dplyr::mutate(
          range = dplyr::case_when(
            zPct >= 98 ~ "Exceptionally High",
            zPct %in% 91:97 ~ "Above Average",
            zPct %in% 75:90 ~ "High-Average",
            zPct %in% 25:74 ~ "Average",
            zPct %in% 9:24 ~ "Low-Average",
            zPct %in% 2:8 ~ "Below Average",
            zPct < 2 ~ "Exceptionally Low",
            TRUE ~ as.character(range)
          )
        )
      
      ncog3 <- arrange(ncog3, desc(zMean))
      
      ncog_level3_status <- tibble(
        name = ncog3$narrow,
        y = ncog3$zMean,
        y2 = ncog3$zPct,
        range = ncog3$range,
        drilldown = tolower(paste(x_level, y_level, name, sep = "_"))
      )
      
      list(
        id = tolower(paste(x_level, y_level, sep = "_")),
        type = "column",
        data = list_parse(ncog_level3_status)
      )
    })
  }) %>% unlist(recursive = FALSE)
```

```{r drilldown-level4}
## Level 4
## Scale scores
## reuse both functions
ncog_level4_drill <-
  lapply(unique(neurocog$domain), function(x_level) {
    ncog2 <- subset(neurocog, neurocog$domain %in% x_level)
    
    lapply(unique(ncog2$subdomain), function(y_level) {
      ncog3 <- subset(ncog2, ncog2$subdomain %in% y_level)
      
      lapply(unique(ncog3$narrow), function(z_level) {
        ncog4 <- subset(ncog3, ncog3$narrow %in% z_level)
        
        ncog4 <-
          ncog4 %>%
          group_by(scale) %>%
          summarize(zMean = mean(z),
                    zPct = mean(percentile)) %>%
          mutate(range = NA)
        
        # round z-score to 1 decimal
        ncog4$zMean <- round(ncog4$zMean, 2L)
        ncog4$zPct <- round(ncog4$zPct, 0L)
        ncog4 <-
          ncog4 %>%
          dplyr::mutate(
            range = dplyr::case_when(
              zPct >= 98 ~ "Exceptionally High",
              zPct %in% 91:97 ~ "Above Average",
              zPct %in% 75:90 ~ "High-Average",
              zPct %in% 25:74 ~ "Average",
              zPct %in% 9:24 ~ "Low-Average",
              zPct %in% 2:8 ~ "Below Average",
              zPct < 2 ~ "Exceptionally Low",
              TRUE ~ as.character(range)
            )
          )
        
        ncog4 <- arrange(ncog4, desc(zMean))
        
        ncog_level4_status <- tibble(
          name = ncog4$scale,
          y = ncog4$zMean,
          y2 = ncog4$zPct,
          range = ncog4$range
        )
        
        list(
          id = tolower(paste(x_level, y_level, z_level, sep = "_")),
          type = "column",
          data = list_parse(ncog_level4_status)
        )
      })
    }) %>% unlist(recursive = FALSE)
  }) %>% unlist(recursive = FALSE)
```


```{r}
thm_merge <- hc_theme_merge(
  hc_theme_monokai(),
  hc_theme_darkunica()
)
```

```{r drilldown-plot, fig.cap='Highchart`R` Drilldown on Cognitive Scores', fig.width=12, fig.height=8, fig.retina=3, out.width = "100%"}
# Tooltip
x <- c("Name", "Score", "Percentile", "Range")
y <- c("{point.name}", "{point.y}", "{point.y2}", "{point.range}")
tt <- tooltip_table(x, y)

## Create drilldown bar plot zscores
plot1 <-
  highchart() %>%
  hc_title(
    text = patient,
    style = list(
      fontSize = "15px")) %>%
  hc_add_series(
    ncog_level1_status,
    type = "bar",
    name = "Neuropsychological Test Scores",
    hcaes(x = name, y = y)) %>%
  hc_xAxis(
    type = "category",
    title = list(
      text = "Domain"),
    categories = .$name) %>%
  hc_yAxis(
    title = list(
      text = "Z-Score (M = 0, SD = 1)"),
    labels = list(
      format = "{value}")) %>%
  hc_tooltip(
    pointFormat = tt,
    useHTML = TRUE,
    valueDecimals = 1) %>%
  hc_plotOptions(
    series = list(
      colorByPoint = TRUE,
      allowPointSelect = TRUE,
      dataLabels = TRUE)) %>%
  hc_drilldown(
    allowPointDrilldown = TRUE,
    series = c(
      ncog_level2_drill,
      ncog_level3_drill,
      ncog_level4_drill)) %>%
  hc_colorAxis(
    minColor = "red",
    maxColor = "blue") %>%
  hc_add_theme(
    thm_merge) %>% 
  hc_chart(
    style = list(
      fontFamily = "Cabin"),
    backgroundColor = list("gray")
  )
plot1
```

---

## Behavioral Data

```{r drilldown2-level1}
## Level 1
## Domain scores
# 1. create mean z-scores for domain
ncog1 <- neurocog %>%
  dplyr::group_by(domain) %>%
  dplyr::summarize(zMean = mean(z),
                   zPct = mean(percentile)) %>%
  dplyr::mutate(range = NA)
ncog1$zMean <- round(ncog1$zMean, 2L)
ncog1$zPct <- round(ncog1$zPct, 0L)
ncog1 <-
  ncog1 %>%
  dplyr::mutate(
    range = dplyr::case_when(
      zPct >= 98 ~ "Exceptionally High",
      zPct %in% 91:97 ~ "Above Average",
      zPct %in% 75:90 ~ "High-Average",
      zPct %in% 25:74 ~ "Average",
      zPct %in% 9:24 ~ "Low-Average",
      zPct %in% 2:8 ~ "Below Average",
      zPct < 2 ~ "Exceptionally Low",
      TRUE ~ as.character(range)
    )
  )

# 2. sort hi to lo
ncog1 <- arrange(ncog1, desc(zMean))

# 3. create tibble with new column with domain name lowercase
ncog_level1_status <- tibble(
  name = ncog1$domain,
  y = ncog1$zMean,
  y2 = ncog1$zPct,
  range = ncog1$range,
  drilldown = tolower(name)
)
```

```{r drilldown2-level2}
## Level 2
## Subdomain scores
## function to create second level of drilldown (subdomain scores)
ncog_level2_drill <-
  lapply(unique(neurocog$domain), function(x_level) {
    ncog2 <- subset(neurocog, neurocog$domain %in% x_level)
    
    # same as above
    ncog2 <-
      ncog2 %>%
      group_by(subdomain) %>%
      summarize(zMean = mean(z),
                zPct = mean(percentile)) %>%
      mutate(range = NA)
    
    # round z-score to 1 decimal
    ncog2$zMean <- round(ncog2$zMean, 2L)
    ncog2$zPct <- round(ncog2$zPct, 0L)
    ncog2 <-
      ncog2 %>%
      dplyr::mutate(
        range = dplyr::case_when(
          zPct >= 98 ~ "Exceptionally High",
          zPct %in% 91:97 ~ "Above Average",
          zPct %in% 75:90 ~ "High-Average",
          zPct %in% 25:74 ~ "Average",
          zPct %in% 9:24 ~ "Low-Average",
          zPct %in% 2:8 ~ "Below Average",
          zPct < 2 ~ "Exceptionally Low",
          TRUE ~ as.character(range)
        )
      )
    
    # 2. sort hi to lo
    ncog2 <- arrange(ncog2, desc(zMean))
    
    # 3. create tibble with new column with domain name lowercase
    ncog_level2_status <- tibble(
      name = ncog2$subdomain,
      y = ncog2$zMean,
      y2 = ncog2$zPct,
      range = ncog2$range,
      drilldown = tolower(paste(x_level, name, sep = "_"))
    )
    
    list(
      id = tolower(x_level),
      type = "column",
      data = list_parse(ncog_level2_status)
    )
  })
```

```{r drilldown2-level3}
## Level 3
## Narrow subdomains
## reuse function
ncog_level3_drill <-
  lapply(unique(neurocog$domain), function(x_level) {
    ncog2 <- subset(neurocog, neurocog$domain %in% x_level)
    
    # reuse function but with y_level
    lapply(unique(ncog2$subdomain), function(y_level) {
      # 1. create mean z-scores for subdomain
      # ncog3 becomes pronoun for domain
      ncog3 <- subset(ncog2, ncog2$subdomain %in% y_level)
      
      ncog3 <- ncog3 %>%
        group_by(narrow) %>%
        summarize(zMean = mean(z), zPct = mean(percentile)) %>%
        mutate(range = NA)
      
      # round z-score to 1 decimal
      ncog3$zMean <- round(ncog3$zMean, 2L)
      ncog3$zPct <- round(ncog3$zPct, 0L)
      ncog3 <-
        ncog3 %>%
        dplyr::mutate(
          range = dplyr::case_when(
            zPct >= 98 ~ "Exceptionally High",
            zPct %in% 91:97 ~ "Above Average",
            zPct %in% 75:90 ~ "High-Average",
            zPct %in% 25:74 ~ "Average",
            zPct %in% 9:24 ~ "Low-Average",
            zPct %in% 2:8 ~ "Below Average",
            zPct < 2 ~ "Exceptionally Low",
            TRUE ~ as.character(range)
          )
        )
      
      ncog3 <- arrange(ncog3, desc(zMean))
      
      ncog_level3_status <- tibble(
        name = ncog3$narrow,
        y = ncog3$zMean,
        y2 = ncog3$zPct,
        range = ncog3$range,
        drilldown = tolower(paste(x_level, y_level, name, sep = "_"))
      )
      
      list(
        id = tolower(paste(x_level, y_level, sep = "_")),
        type = "column",
        data = list_parse(ncog_level3_status)
      )
    })
  }) %>% unlist(recursive = FALSE)
```

```{r drilldown2-level4}
## Level 4
## Scale scores
## reuse both functions
ncog_level4_drill <-
  lapply(unique(neurocog$domain), function(x_level) {
    ncog2 <- subset(neurocog, neurocog$domain %in% x_level)
    
    lapply(unique(ncog2$subdomain), function(y_level) {
      ncog3 <- subset(ncog2, ncog2$subdomain %in% y_level)
      
      lapply(unique(ncog3$narrow), function(z_level) {
        ncog4 <- subset(ncog3, ncog3$narrow %in% z_level)
        
        ncog4 <-
          ncog4 %>%
          group_by(scale) %>%
          summarize(zMean = mean(z),
                    zPct = mean(percentile)) %>%
          mutate(range = NA)
        
        # round z-score to 1 decimal
        ncog4$zMean <- round(ncog4$zMean, 2L)
        ncog4$zPct <- round(ncog4$zPct, 0L)
        ncog4 <-
          ncog4 %>%
          dplyr::mutate(
            range = dplyr::case_when(
              zPct >= 98 ~ "Exceptionally High",
              zPct %in% 91:97 ~ "Above Average",
              zPct %in% 75:90 ~ "High-Average",
              zPct %in% 25:74 ~ "Average",
              zPct %in% 9:24 ~ "Low-Average",
              zPct %in% 2:8 ~ "Below Average",
              zPct < 2 ~ "Exceptionally Low",
              TRUE ~ as.character(range)
            )
          )
        
        ncog4 <- arrange(ncog4, desc(zMean))
        
        ncog_level4_status <- tibble(
          name = ncog4$scale,
          y = ncog4$zMean,
          y2 = ncog4$zPct,
          range = ncog4$range
        )
        
        list(
          id = tolower(paste(x_level, y_level, z_level, sep = "_")),
          type = "column",
          data = list_parse(ncog_level4_status)
        )
      })
    }) %>% unlist(recursive = FALSE)
  }) %>% unlist(recursive = FALSE)
```

```{r}
thm_merge <- hc_theme_merge(
  hc_theme_monokai(),
  hc_theme_darkunica()
)
```

```{r drilldown2-plot, fig.cap='Highchart`R` Drilldown on Behavioral Scores', fig.width=12, fig.height=8, fig.retina=3, out.width = "100%"}
# Tooltip
x <- c("Name", "Score", "Percentile", "Range")
y <- c("{point.name}", "{point.y}", "{point.y2}", "{point.range}")
tt <- tooltip_table(x, y)

## Create drilldown bar plot zscores
plot1 <-
  highchart() %>%
  hc_title(
    text = patient,
    style = list(
      fontSize = "15px")) %>%
  hc_add_series(
    ncog_level1_status,
    type = "bar",
    name = "Neuropsychological Test Scores",
    hcaes(x = name, y = y)) %>%
  hc_xAxis(
    type = "category",
    title = list(
      text = "Domain"),
    categories = .$name) %>%
  hc_yAxis(
    title = list(
      text = "Z-Score (M = 0, SD = 1)"),
    labels = list(
      format = "{value}")) %>%
  hc_tooltip(
    pointFormat = tt,
    useHTML = TRUE,
    valueDecimals = 1) %>%
  hc_plotOptions(
    series = list(
      colorByPoint = TRUE,
      allowPointSelect = TRUE,
      dataLabels = TRUE)) %>%
  hc_drilldown(
    allowPointDrilldown = TRUE,
    series = c(
      ncog_level2_drill,
      ncog_level3_drill,
      ncog_level4_drill)) %>%
  hc_colorAxis(
    minColor = "red",
    maxColor = "blue") %>%
  hc_add_theme(
    thm_merge) %>% 
  hc_chart(
    style = list(
      fontFamily = "Cabin"),
    backgroundColor = list("gray")
  )
plot1
```

---

name: snoop
class: middle, right
background-image: url(https://gifs.joelglovier.com/favs/snoop-turning-the-wheel-big.gif)
background-color: #FFFFFF
background-size: auto
font-style: bold
font-weight: 400

.pull-right[.black[.bold[

"There are three ways to ultimate success:

The first way is to be kind.

The second way is to be kind.

The third way is to be kind."
]
]
]

---
title: "A.D.H.D."
subtitle: "Neuropsychological assessment for diagnostic clarification and treatment planning"
author1: 
  - "Joey W. Trampush, Ph.D."
  - "Della Martin Assistant Professor of Psychiatry"  
author2:
  - "Ashraf Elmashat, M.D."
  - "Professor of Psychiatry"
institute: 
  - "Department of Psychiatry and the Behavioral Sciences"
date: "2021-12-21"
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: ["default", "assets/css/fighton-fonts.css", "assets/css/fighton-theme.css"]
    chakra: libs/remark-latest.min.js
    nature:
      highlightStyle: monokai
      highlightLanguage: ["r", "css", "yaml"]
      highlightLines: true
      countIncrementalSlides: true
      ratio: '16:9'
      navigation: list(click = true)
      slideNumberFormat: |
        <div class="progress-bar-container">
          <div class="progress-bar" style="width: calc(%current% / %total% * 100%);">
          </div>
        </div>
      includePresenterNotes: yes
      countdown: 60000
      beforeInit: ["libs/macros.js"]
    self_contained: false
    anchor_sections: false
    seal: false
    includes:
      in_header: header.html        
---

```{r setup, include=FALSE}
## load libraries
library(knitr)
library(xaringan)
library(xaringanExtra)
library(xaringanBuilder)
library(xaringanthemer)
library(rmarkdown)
library(revealjs)
library(blogdown)
library(dataui)
library(reactable)
library(tidyverse)
library(highcharter)
library(htmlwidgets)
library(widgetframe)
library(crosstalk)
library(manipulateWidget)
library(tibble)
library(svglite)
library(gifski)

## knitr options
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(
  fig.path = "figs/",
  fig.width = 12,
  fig.height = 4,
  fig.asp = .5, # might not work
  fig.retina = 3,
  out.width = "100%",
  fig.showtext = TRUE,
  comment = NULL,
  cache = FALSE,
  cache.path = "cache/",
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  dev = c("svg", "svglite"),
  hiline = TRUE
)
```

```{r xaringan-extra, include=F}
xaringanExtra::use_animate_css(minified = FALSE, xaringan = TRUE)
xaringanExtra::use_tachyons()
xaringanExtra::use_tile_view()
xaringanExtra::use_broadcast()
xaringanExtra::use_scribble()
xaringanExtra::use_panelset()
xaringanExtra::use_webcam()
xaringanExtra::style_panelset_tabs(font_family = "inherit")
xaringanExtra::use_freezeframe()
xaringanExtra::use_fit_screen()
xaringanExtra::use_extra_styles(
  hover_code_line = TRUE, #<<
  mute_unhighlighted_code = TRUE #<<
)
xaringanExtra::use_share_again()
```

name: title
class: title-slide, left, middle
background-image: url(images/daftpunktocat-thomas.gif)
background-position: right
background-repeat: no-repeat
background-size: contain
background-color: var(--usc-black)

.pull-left[
# `r rmarkdown::metadata$title`
## `r rmarkdown::metadata$subtitle`
### `r rmarkdown::metadata$author1`
### `r rmarkdown::metadata$author2`
### `r rmarkdown::metadata$institute`
![:scale 60%](images/2-Line_KeckSOMofUSC_CardOnBlack.jpg)
]

---

name: hello
class: middle, center
background-color: var(--near-black)

## Hello.

???

Our department has grown since 2018

---

class: middle, center
background-color: var(--near-black)

.bg-near-black.b--dark-green.ba.bw2.br3.shadow-5.ph4.mt5[
If you cannot explain something in simple terms, you don't understand it.

.tr[
— Richard Feynman
]]

.center[![:scale 45%](images/jerry_maguire.gif)]

---

class: middle

What do we know about .big[ADHD]?

.footnote.pull-left[
[`r fontawesome::fa("github")` @brainworkup](https://github.com/brainworkup)
[`r fontawesome::fa("twitter")` @brainworkup](https://twitter.com/brainworkup)   
[`r fontawesome::fa("link")` brainworkup.io](https://brainworkup.io)
]

.pull-right[![:scale 75%](images/dinotocat.png)]

???

80HD
PATS preschool study

---

class: center, middle, section

.frame[
### Developmental Trajectory of ADHD
]

This is the model of ADHD from which I work ...

--

![:scale 80%](images/halperin_schulz.png)

???
#### Notes
- note 
- note

---

class: center, middle, inverse

### Cognitive Development in Preschoolers At-Risk for ADHD

.pull-left[
![:scale 60%](images/ajp_2013.png)
]

.pull-right[
![:scale 40%](images/ajp_2013_fig1.png)
]

???

#### Notes
- note 
- note

---

class: section middle center

## Clinical ADHD .red[vs.] Cognitive ADHD

.pull-left[
### inattention
### hyperactivity
### impulsivity
]

.pull-right[
### attentional fluency
### stimulus-boundness
### emotion regulation
]

---

class: center, middle

### paper on the CAARS adult adhd

---

class: center, middle, inverse, f2

`Executive Dysfunction in ADHD`

Three core areas ... 

---

class: center middle

.big[1.]

## attentional fluency

---

class: middle, center

### Attentional Fluency

How .fat-font[much] and how .fat-font[fast] ...

.left.pull-left[
#### Working Memory

- Verbal WM
  - Maintenace/manipulation of information in conscious awareness
  - Fluency of retrieval of information from long-term memory
- Nonverbal WM
  - "Mind's eye"
  - Episodic future thinking
]

.left.pull-right[
#### Processing Speed/Variability

- Regulating alertness
- Sustaining effort during repetitive, boring tasks
- Adjusting processing speed
- Completing tasks
- Maintaining performance consistency
]

???
- EFT: this is why planning is impaired

---

name: devsci

### Working memory skills are influenced by genetic variation in dopamine receptor genes and correlate with symptom remission in ADHD 

.pull-left[![:scale 70%](images/trampush_devsci.png)]

.pull-right[![:scale 70%](images/trampush_devsci_fig1.png)]

---

class: center, middle

### GWAS of Working Memory

Currently funded to conduct large-scale molecular genetic analysis of working memory in .blue[**>25,000 people**], .blue[**>70,000 WM phenotypes**], and .blue[**>293,000,000 genetic variants**]

.pull-left[
  ![:scale 65%](images/wm.gif)
]

.pull-right[
  ![:scale 65%](images/gwm_fig1.png)
]

---

name: rtsd

.left-column[
### RTSD as a biomarker of lifelong ADHD

- Reaction time variability
- Response (in)consistency
  - in anything really
- Attentional drift
  - slow RTs
- Impulsive responding
  - fast RTs
]

.right-column[
![:scale 75%](images/halperin-2008.png)
]

---

class: center, middle
background-color: var(--near-black)

.big[2.]

## stimulus-boundness

---

>**Stimulus-boundedness**:
>
>...is an inappropriate response to a salient environmental stimulus. 
>
>Such behaviors could include
>- unsolicited reading of nearby text
>- environmental dependency (e.g., picking up a pen from the table and writing
>- eating food from someone else’s plate)
>- excessive attention to irrelevant objects (e.g., picking up objects from floor)
>- echolalia/echopraxia
>- during cognitive testing, writing or drawing on a model or adjacent stimulus
>- closing in on a stimulus or being distracted by adjacent stimuli
>- environmentally dependent behaviors occur often and subject cannot be easily redirected and/or environmental dependency makes task completion very difficult

.footnote[NIH EXAMINER Behavior Rating Scale]

???

- stems from frontal lobe damaged pts

---

class: center, middle
background-color: var(--near-black)

.big[3.]

## emotional / affective  regulation

---

name: bell
class: left, middle, fullscale
background-image: url(https://gifs.joelglovier.com/crying/laughing-crying.gif)
background-position: 50% 50%
background-size: 100%

## Emotional Control

.pull-left[
> **Emotion** `r emo::ji("fire")`
>
> **(Dys)Regulation**
> 
> in **ADHD**
>
>
> Not part of DSM/ICD diagnostic criteria 
>
> .big[BUT] ...
>
]

???

This is recognized on most rating scales e.g., brown

---

>**Managing Frustration and Modulating Emotions**
>
>The Emotion cluster addresses difficulties individuals may have with regulating emotional reactions .yellow[**to the extent that they take over much of what the individuals are thinking or doing**]. 
>
>Although the DSM-5 does not recognize any symptoms related to emotion management as an aspect of ADHD, many with the disorder describe chronic difficulties managing frustration, anger, worry, disappointment, desire, and other emotions. They find it very difficult to put their emotions into perspective and get on with what they need to do.
>
>.yellow[**Many speak as though these emotions, when experienced, take over their thinking the way a computer virus might infect a computer and make it impossible for them to attend to anything else**]. 
>
>Example items: excessive irritability, sensitivity to criticism, overwhelming nervousness and worry, and unhappiness.

.footnote[Brown Executive Function/Attention Scales]

---

class: center, middle

## Case Presentation

---

class: middle

### "Scout"

1. Name
1. Age
1. Grade

???

- 874. Scout
- 875. SL

---

### Background

- History
- Anti-vacinnation

---

name: gauss1
class: middle center animated slideInRight fadeOutLeft
background-color: var(--near-black)
background-size: auto

### Distribution of Scores: _Population-level Interpretation_

```{r gauss-plot1, fig.cap='Statistical classification of neuropsychological test scores in the general population.', fig.retina=3, fig.asp=0.5, out.width = '50%'}
knitr::include_graphics("images/plot_narrow.png", auto_pdf = TRUE)
```

---

name: gauss2
class: middle center animated slideInLeft fadeOutRight 
background-color: var(--near-black)
background-size: auto

### Distribution of Scores: _Clinical Interpretation_

```{r gauss-plot2, fig.cap='General clinical interpretation of performance for individual test scores and broader neuropsychological domains.', fig.retina=3, fig.asp=0.5, out.width = '50%'}
# change these to match if necessary
knitr::include_graphics("images/plot_broad.png", auto_pdf = TRUE)
```

---

class: animated slideInRight fadeOutLeft
background-color: var(--near-black)

### Cognitive Data

```{r patient}
patient <- "Scout"
```

```{r echo=FALSE}
library(highcharter)
library(tidyverse)
library(htmlwidgets)
library(widgetframe)
```

```{r read-csv}
data_path <- here::here(patient, "csv")
files <- dir(data_path, pattern = "*.csv")
neuropsych <-
  files %>%
  set_names() %>%
  map_df(
    ~ readr::read_csv(file.path(data_path, .), show_col_types = FALSE),
    na = c("", "NA", "--", "-"),
    .id = "filename"
  ) %>%
  filter(!is.na(percentile)) %>%
  distinct() %>%
  mutate(z = qnorm(percentile / 100)) %>%
  mutate(domain = forcats::as_factor(domain)) %>%
  mutate(subdomain = forcats::as_factor(subdomain)) %>%
  mutate(narrow = forcats::as_factor(narrow)) %>%
  mutate(pass = forcats::as_factor(pass)) %>%
  mutate(verbal = forcats::as_factor(verbal)) %>%
  mutate(timed = forcats::as_factor(timed))
```

```{r, make-factors-neurocog}
# Subset neurocognitive data
neurocog <-
  neuropsych %>%
  filter(test_type == "npsych_test")
# domain
neurocog <-
  neurocog %>%
  group_by(domain, .add = TRUE) %>%
  filter(!is.na(percentile)) %>%
  mutate(z_mean_dom = mean(z), z_sd_dom = sd(z)) %>%
  mutate(
    pct_mean_dom = mean(percentile),
    pct_sd_dom = sd(percentile)
  ) %>%
  ungroup()
# subdomain
neurocog <-
  neurocog %>%
  group_by(subdomain, .add = TRUE) %>%
  filter(!is.na(percentile)) %>%
  mutate(z_mean_sub = mean(z), z_sd_sub = sd(z)) %>%
  mutate(
    pct_mean_sub = mean(percentile),
    pct_sd_sub = sd(percentile)
  ) %>%
  ungroup()
# narrow
neurocog <-
  neurocog %>%
  group_by(narrow, .add = TRUE) %>%
  filter(!is.na(percentile)) %>%
  mutate(z_mean_narrow = mean(z), z_sd_narrow = sd(z)) %>%
  mutate(
    pct_mean_narrow = mean(percentile),
    pct_sd_narrow = sd(percentile)
  ) %>%
  ungroup()
# pass
neurocog <-
  neurocog %>%
  group_by(pass, .add = TRUE) %>%
  filter(!is.na(percentile)) %>%
  mutate(z_mean_pass = mean(z), z_sd_pass = sd(z)) %>%
  ungroup()
# verbal
neurocog <-
  neurocog %>%
  group_by(verbal, .add = TRUE) %>%
  filter(!is.na(percentile)) %>%
  mutate(z_mean_verbal = mean(z), z_sd_verbal = sd(z)) %>%
  ungroup()
# timed
neurocog <-
  neurocog %>%
  group_by(timed, .add = TRUE) %>%
  filter(!is.na(percentile)) %>%
  mutate(z_mean_timed = mean(z), z_sd_timed = sd(z)) %>%
  ungroup()
# result text
neurocog <-
  neurocog %>%
  dplyr::mutate(
    result = glue::glue(
      "{patient}'s score on {scale}, a measure of {description}, fell in the *{range}* range (PR = {percentile})."
    )
  )
```

```{r, make-factors-neurobehav}
# Subset neurobehavioral data
neurobehav <-
  neuropsych %>%
  filter(test_type != "npsych_test")
# domain
neurobehav <-
  neurobehav %>%
  group_by(domain, .add = TRUE) %>%
  filter(!is.na(score)) %>%
  mutate(z_mean_dom = mean(z), z_sd_dom = sd(z)) %>%
  mutate(
    pct_mean_dom = mean(percentile),
    pct_sd_dom = sd(percentile)
  ) %>%
  ungroup()
# subdomain
neurobehav <-
  neurobehav %>%
  group_by(subdomain, .add = TRUE) %>%
  filter(!is.na(score)) %>%
  mutate(z_mean_sub = mean(z), z_sd_sub = sd(z)) %>%
  mutate(
    pct_mean_sub = mean(percentile),
    pct_sd_sub = sd(percentile)
  ) %>%
  ungroup()
# narrow
neurobehav <-
  neurobehav %>%
  group_by(narrow, .add = TRUE) %>%
  filter(!is.na(score)) %>%
  mutate(z_mean_narrow = mean(z), z_sd_narrow = sd(z)) %>%
  mutate(
    pct_mean_narrow = mean(percentile),
    pct_sd_narrow = sd(percentile)
  ) %>%
  ungroup()
# result text
neurobehav <-
  neurobehav %>%
  dplyr::mutate(
    result = glue::glue(
      "{patient}'s score on {scale}, a measure of {description}, fell in the *{range}* range (PR = {percentile})."
    )
  )
```

```{r, write-data}
readr::write_csv(neuropsych, here::here(patient, "neuropsych.csv"))
readr::write_csv(neurocog, here::here(patient, "neurocog.csv"))
readr::write_csv(neurobehav, here::here(patient, "neurobehav.csv"))
```

```{r, read-data}
neuropsych <-
  readr::read_csv(here::here(patient, "neuropsych.csv"), show_col_types = FALSE)
neurocog <-
  readr::read_csv(here::here(patient, "neurocog.csv"), show_col_types = FALSE)
neurobehav <-
  readr::read_csv(here::here(patient, "neurobehav.csv"), show_col_types = FALSE)
```

```{r drilldown-level1}
## Level 1
## Domain scores
# 1. create mean z-scores for domain
ncog1 <- neurocog %>%
  dplyr::group_by(domain) %>%
  dplyr::summarize(zMean = mean(z),
                   zPct = mean(percentile)) %>%
  dplyr::mutate(range = NA)
ncog1$zMean <- round(ncog1$zMean, 2L)
ncog1$zPct <- round(ncog1$zPct, 0L)
ncog1 <-
  ncog1 %>%
  dplyr::mutate(
    range = dplyr::case_when(
      zPct >= 98 ~ "Exceptionally High",
      zPct %in% 91:97 ~ "Above Average",
      zPct %in% 75:90 ~ "High-Average",
      zPct %in% 25:74 ~ "Average",
      zPct %in% 9:24 ~ "Low-Average",
      zPct %in% 2:8 ~ "Below Average",
      zPct < 2 ~ "Exceptionally Low",
      TRUE ~ as.character(range)
    )
  )

# 2. sort hi to lo
ncog1 <- arrange(ncog1, desc(zMean))

# 3. create tibble with new column with domain name lowercase
ncog_level1_status <- tibble(
  name = ncog1$domain,
  y = ncog1$zMean,
  y2 = ncog1$zPct,
  range = ncog1$range,
  drilldown = tolower(name)
)
```

```{r drilldown-level2}
## Level 2
## Subdomain scores
## function to create second level of drilldown (subdomain scores)
ncog_level2_drill <-
  lapply(unique(neurocog$domain), function(x_level) {
    ncog2 <- subset(neurocog, neurocog$domain %in% x_level)
    
    # same as above
    ncog2 <-
      ncog2 %>%
      group_by(subdomain) %>%
      summarize(zMean = mean(z),
                zPct = mean(percentile)) %>%
      mutate(range = NA)
    
    # round z-score to 1 decimal
    ncog2$zMean <- round(ncog2$zMean, 2L)
    ncog2$zPct <- round(ncog2$zPct, 0L)
    ncog2 <-
      ncog2 %>%
      dplyr::mutate(
        range = dplyr::case_when(
          zPct >= 98 ~ "Exceptionally High",
          zPct %in% 91:97 ~ "Above Average",
          zPct %in% 75:90 ~ "High-Average",
          zPct %in% 25:74 ~ "Average",
          zPct %in% 9:24 ~ "Low-Average",
          zPct %in% 2:8 ~ "Below Average",
          zPct < 2 ~ "Exceptionally Low",
          TRUE ~ as.character(range)
        )
      )
    
    # 2. sort hi to lo
    ncog2 <- arrange(ncog2, desc(zMean))
    
    # 3. create tibble with new column with domain name lowercase
    ncog_level2_status <- tibble(
      name = ncog2$subdomain,
      y = ncog2$zMean,
      y2 = ncog2$zPct,
      range = ncog2$range,
      drilldown = tolower(paste(x_level, name, sep = "_"))
    )
    
    list(
      id = tolower(x_level),
      type = "column",
      data = list_parse(ncog_level2_status)
    )
  })
```

```{r drilldown-level3}
## Level 3
## Narrow subdomains
## reuse function
ncog_level3_drill <-
  lapply(unique(neurocog$domain), function(x_level) {
    ncog2 <- subset(neurocog, neurocog$domain %in% x_level)
    
    # reuse function but with y_level
    lapply(unique(ncog2$subdomain), function(y_level) {
      # 1. create mean z-scores for subdomain
      # ncog3 becomes pronoun for domain
      ncog3 <- subset(ncog2, ncog2$subdomain %in% y_level)
      
      ncog3 <- ncog3 %>%
        group_by(narrow) %>%
        summarize(zMean = mean(z), zPct = mean(percentile)) %>%
        mutate(range = NA)
      
      # round z-score to 1 decimal
      ncog3$zMean <- round(ncog3$zMean, 2L)
      ncog3$zPct <- round(ncog3$zPct, 0L)
      ncog3 <-
        ncog3 %>%
        dplyr::mutate(
          range = dplyr::case_when(
            zPct >= 98 ~ "Exceptionally High",
            zPct %in% 91:97 ~ "Above Average",
            zPct %in% 75:90 ~ "High-Average",
            zPct %in% 25:74 ~ "Average",
            zPct %in% 9:24 ~ "Low-Average",
            zPct %in% 2:8 ~ "Below Average",
            zPct < 2 ~ "Exceptionally Low",
            TRUE ~ as.character(range)
          )
        )
      
      ncog3 <- arrange(ncog3, desc(zMean))
      
      ncog_level3_status <- tibble(
        name = ncog3$narrow,
        y = ncog3$zMean,
        y2 = ncog3$zPct,
        range = ncog3$range,
        drilldown = tolower(paste(x_level, y_level, name, sep = "_"))
      )
      
      list(
        id = tolower(paste(x_level, y_level, sep = "_")),
        type = "column",
        data = list_parse(ncog_level3_status)
      )
    })
  }) %>% unlist(recursive = FALSE)
```

```{r drilldown-level4}
## Level 4
## Scale scores
## reuse both functions
ncog_level4_drill <-
  lapply(unique(neurocog$domain), function(x_level) {
    ncog2 <- subset(neurocog, neurocog$domain %in% x_level)
    
    lapply(unique(ncog2$subdomain), function(y_level) {
      ncog3 <- subset(ncog2, ncog2$subdomain %in% y_level)
      
      lapply(unique(ncog3$narrow), function(z_level) {
        ncog4 <- subset(ncog3, ncog3$narrow %in% z_level)
        
        ncog4 <-
          ncog4 %>%
          group_by(scale) %>%
          summarize(zMean = mean(z),
                    zPct = mean(percentile)) %>%
          mutate(range = NA)
        
        # round z-score to 1 decimal
        ncog4$zMean <- round(ncog4$zMean, 2L)
        ncog4$zPct <- round(ncog4$zPct, 0L)
        ncog4 <-
          ncog4 %>%
          dplyr::mutate(
            range = dplyr::case_when(
              zPct >= 98 ~ "Exceptionally High",
              zPct %in% 91:97 ~ "Above Average",
              zPct %in% 75:90 ~ "High-Average",
              zPct %in% 25:74 ~ "Average",
              zPct %in% 9:24 ~ "Low-Average",
              zPct %in% 2:8 ~ "Below Average",
              zPct < 2 ~ "Exceptionally Low",
              TRUE ~ as.character(range)
            )
          )
        
        ncog4 <- arrange(ncog4, desc(zMean))
        
        ncog_level4_status <- tibble(
          name = ncog4$scale,
          y = ncog4$zMean,
          y2 = ncog4$zPct,
          range = ncog4$range
        )
        
        list(
          id = tolower(paste(x_level, y_level, z_level, sep = "_")),
          type = "column",
          data = list_parse(ncog_level4_status)
        )
      })
    }) %>% unlist(recursive = FALSE)
  }) %>% unlist(recursive = FALSE)
```


```{r}
thm_merge <- hc_theme_merge(
  hc_theme_monokai(),
  hc_theme_darkunica()
)
```

```{r drilldown-plot, fig.cap='Highchart`R` Drilldown on Cognitive Scores', fig.width=12, fig.height=8, fig.retina=3, out.width = "100%"}
# Tooltip
x <- c("Name", "Score", "Percentile", "Range")
y <- c("{point.name}", "{point.y}", "{point.y2}", "{point.range}")
tt <- tooltip_table(x, y)

## Create drilldown bar plot zscores
plot1 <-
  highchart() %>%
  hc_title(
    text = patient,
    style = list(
      fontSize = "15px")) %>%
  hc_add_series(
    ncog_level1_status,
    type = "bar",
    name = "Neuropsychological Test Scores",
    hcaes(x = name, y = y)) %>%
  hc_xAxis(
    type = "category",
    title = list(
      text = "Domain"),
    categories = .$name) %>%
  hc_yAxis(
    title = list(
      text = "Z-Score (M = 0, SD = 1)"),
    labels = list(
      format = "{value}")) %>%
  hc_tooltip(
    pointFormat = tt,
    useHTML = TRUE,
    valueDecimals = 1) %>%
  hc_plotOptions(
    series = list(
      colorByPoint = TRUE,
      allowPointSelect = TRUE,
      dataLabels = TRUE)) %>%
  hc_drilldown(
    allowPointDrilldown = TRUE,
    series = c(
      ncog_level2_drill,
      ncog_level3_drill,
      ncog_level4_drill)) %>%
  hc_colorAxis(
    minColor = "red",
    maxColor = "blue") %>%
  hc_add_theme(
    thm_merge) %>% 
  hc_chart(
    style = list(
      fontFamily = "Cabin"),
    backgroundColor = list("gray")
  )
plot1
```

???

- These are her cognitive scores
## MOTOR
- motor impersistence
- sequencing vs tapping
- dominant vs nondominant hand dexterity; atypical laterlization

---

class: animated slideInLeft fadeOutRight 
background-color: var(--near-black)

### Behavioral Data

```{r drilldown2-level1}
## Level 1
## Domain scores
# 1. create mean z-scores for domain
nbhv1 <- neurobehav %>%
  dplyr::group_by(domain) %>%
  dplyr::summarize(zMean = mean(z),
                   zPct = mean(percentile)) %>%
  dplyr::mutate(range = NA)
nbhv1$zMean <- round(nbhv1$zMean, 0L)
nbhv1$zPct <- round(nbhv1$zPct, 0L)
nbhv1 <-
  nbhv1 %>%
  dplyr::mutate(
    range = dplyr::case_when(
      zMean >= 3 ~ "Markedly Elevated",
      zMean %in% 2:2.9 ~ "Significantly Elevated",
      zMean %in% 1:1.9 ~ "Mildly Elevated",
      zMean %in% -1:0.9 ~ "Average",
      zMean <= -1.1 ~ "Below Average",
      # zPct > 99 ~ "Markedly Elevated",
      # zPct %in% 98:99 ~ "Significantly Elevated",
      # zPct %in% 84:97 ~ "Mildly Elevated",
      # zPct %in% 16:83 ~ "WNL",
      # zPct <= 82 ~ "Below Average",
      TRUE ~ as.character(range)
    )
  )

# 2. sort hi to lo
nbhv1 <- arrange(nbhv1, desc(zMean))

# 3. create tibble with new column with domain name lowercase
nbhv_level1_status <- tibble(
  name = nbhv1$domain,
  y = nbhv1$zMean,
  y2 = nbhv1$zPct,
  range = nbhv1$range,
  drilldown = tolower(name)
)
```

```{r drilldown2-level2}
## Level 2
## Subdomain scores
## function to create second level of drilldown (subdomain scores)
nbhv_level2_drill <-
  lapply(unique(neurobehav$domain), function(x_level) {
    nbhv2 <- subset(neurobehav, neurobehav$domain %in% x_level)
    
    # same as above
    nbhv2 <-
      nbhv2 %>%
      group_by(subdomain) %>%
      summarize(zMean = mean(z),
                zPct = mean(percentile)) %>%
      mutate(range = NA)
    
    # round z-score to 1 decimal
    nbhv2$zMean <- round(nbhv2$zMean, 0L)
    nbhv2$zPct <- round(nbhv2$zPct, 0L)
    nbhv2 <-
      nbhv2 %>%
      dplyr::mutate(
        range = dplyr::case_when(
          zMean >= 3 ~ "Markedly Elevated",
          zMean %in% 2:2.9 ~ "Significantly Elevated",
          zMean %in% 1:1.9 ~ "Mildly Elevated",
          zMean %in% -1:0.9 ~ "Average",
          zMean <= -1.1 ~ "Below Average",
          TRUE ~ as.character(range)
        )
      )
    
    # 2. sort hi to lo
    nbhv2 <- arrange(nbhv2, desc(zMean))
    
    # 3. create tibble with new column with domain name lowercase
    nbhv_level2_status <- tibble(
      name = nbhv2$subdomain,
      y = nbhv2$zMean,
      y2 = nbhv2$zPct,
      range = nbhv2$range,
      drilldown = tolower(paste(x_level, name, sep = "_"))
    )
    
    list(
      id = tolower(x_level),
      type = "column",
      data = list_parse(nbhv_level2_status)
    )
  })
```

```{r drilldown2-level3}
## Level 3
## Narrow subdomains
## reuse function
nbhv_level3_drill <-
  lapply(unique(neurobehav$domain), function(x_level) {
    nbhv2 <- subset(neurobehav, neurobehav$domain %in% x_level)
    
    # reuse function but with y_level
    lapply(unique(nbhv2$subdomain), function(y_level) {
      # 1. create mean z-scores for subdomain
      # nbhv3 becomes pronoun for domain
      nbhv3 <- subset(nbhv2, nbhv2$subdomain %in% y_level)
      
      nbhv3 <- nbhv3 %>%
        group_by(narrow) %>%
        summarize(zMean = mean(z), zPct = mean(percentile)) %>%
        mutate(range = NA)
      
      # round z-score to 1 decimal
      nbhv3$zMean <- round(nbhv3$zMean, 0L)
      nbhv3$zPct <- round(nbhv3$zPct, 0L)
      nbhv3 <-
        nbhv3 %>%
        dplyr::mutate(
          range = dplyr::case_when(
            zMean >= 3 ~ "Markedly Elevated",
            zMean %in% 2:2.9 ~ "Significantly Elevated",
            zMean %in% 1:1.9 ~ "Mildly Elevated",
            zMean %in% -1:0.9 ~ "Average",
            zMean <= -1.1 ~ "Below Average",
            TRUE ~ as.character(range)
          )
        )
      
      nbhv3 <- arrange(nbhv3, desc(zMean))
      
      nbhv_level3_status <- tibble(
        name = nbhv3$narrow,
        y = nbhv3$zMean,
        y2 = nbhv3$zPct,
        range = nbhv3$range,
        drilldown = tolower(paste(x_level, y_level, name, sep = "_"))
      )
      
      list(
        id = tolower(paste(x_level, y_level, sep = "_")),
        type = "column",
        data = list_parse(nbhv_level3_status)
      )
    })
  }) %>% unlist(recursive = FALSE)
```

```{r drilldown2-level4}
## Level 4
## Scale scores
## reuse both functions
nbhv_level4_drill <-
  lapply(unique(neurobehav$domain), function(x_level) {
    nbhv2 <- subset(neurobehav, neurobehav$domain %in% x_level)
    
    lapply(unique(nbhv2$subdomain), function(y_level) {
      nbhv3 <- subset(nbhv2, nbhv2$subdomain %in% y_level)
      
      lapply(unique(nbhv3$narrow), function(z_level) {
        nbhv4 <- subset(nbhv3, nbhv3$narrow %in% z_level)
        
        nbhv4 <-
          nbhv4 %>%
          group_by(scale) %>%
          summarize(zMean = mean(z),
                    zPct = mean(percentile)) %>%
          mutate(range = NA)
        
        # round z-score to 1 decimal
        nbhv4$zMean <- round(nbhv4$zMean, 0L)
        nbhv4$zPct <- round(nbhv4$zPct, 0L)
        nbhv4 <-
          nbhv4 %>%
          dplyr::mutate(
            range = dplyr::case_when(
              zMean >= 3 ~ "Markedly Elevated",
              zMean %in% 2:2.9 ~ "Significantly Elevated",
              zMean %in% 1:1.9 ~ "Mildly Elevated",
              zMean %in% -1:0.9 ~ "Average",
              zMean <= -1.1 ~ "Below Average",
              TRUE ~ as.character(range)
            )
          )
        
        nbhv4 <- arrange(nbhv4, desc(zMean))
        
        nbhv_level4_status <- tibble(
          name = nbhv4$scale,
          y = nbhv4$zMean,
          y2 = nbhv4$zPct,
          range = nbhv4$range
        )
        
        list(
          id = tolower(paste(x_level, y_level, z_level, sep = "_")),
          type = "column",
          data = list_parse(nbhv_level4_status)
        )
      })
    }) %>% unlist(recursive = FALSE)
  }) %>% unlist(recursive = FALSE)
```

```{r}
thm_merge <- hc_theme_merge(
  hc_theme_monokai(),
  hc_theme_darkunica()
)
```

```{r drilldown2-plot, fig.cap='Highchart`R` Drilldown on Behavioral Ratings', fig.width=12, fig.height=8, fig.retina=3, out.width = "100%"}
# Tooltip
x <- c("Name", "Score", "Percentile", "Range")
y <- c("{point.name}", "{point.y}", "{point.y2}", "{point.range}")
tt <- tooltip_table(x, y)

## Create drilldown bar plot zscores
plot1 <-
  highchart() %>%
  hc_title(
    text = patient,
    style = list(
      fontSize = "15px")) %>%
  hc_add_series(
    nbhv_level1_status,
    type = "bar",
    name = "Behavioral Rating Scales",
    hcaes(x = name, y = y)) %>%
  hc_xAxis(
    type = "category",
    title = list(
      text = "Domain"),
    categories = .$name) %>%
  hc_yAxis(
    title = list(
      text = "Z-Score (M = 0, SD = 1)"),
    labels = list(
      format = "{value}")) %>%
  hc_tooltip(
    pointFormat = tt,
    useHTML = TRUE,
    valueDecimals = 1) %>%
  hc_plotOptions(
    series = list(
      colorByPoint = TRUE,
      allowPointSelect = TRUE,
      dataLabels = TRUE)) %>%
  hc_drilldown(
    allowPointDrilldown = TRUE,
    series = c(
      nbhv_level2_drill,
      nbhv_level3_drill,
      nbhv_level4_drill)) %>%
  hc_colorAxis(
    minColor = "red",
    maxColor = "blue") %>%
  hc_add_theme(
    thm_merge) %>% 
  hc_chart(
    style = list(
      fontFamily = "Cabin"),
    backgroundColor = list("gray")
  )
plot1
```

???

## Behavioral
- make 3 groups (parent, self, basc vs brown)
- ADLs very impaired
- collapsed across all domains is 1.2 SDs

---

class: section

## Summary

- point 1
- point 2
- point 3

---

class: center, middle
background-size: container

### Follow-Up from Mom ...

![:scale 70%](images/mom_note.png)

???

- mom emailed about 2-3 months later 

---

name: snoop
class: middle, right, lbc
background-image: url(https://gifs.joelglovier.com/favs/snoop-turning-the-wheel-big.gif)
background-color: #FFFFFF
background-size: auto

.lbc.pull-right[

"There are three ways to ultimate success:

The first way is to be kind.

The second way is to be kind.

The third way is to be kind."

]

???

- Mr Rogers
[](https://jasonstcyr.com/2019/11/27/building-trust-have-you-been-kind-today/)

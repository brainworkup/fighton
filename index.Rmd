---
title: "Help Me Help You:"
subtitle: "Neuropsychological Assessment of ADHD"
author: 
  - "Joey Trampush, PhD"
  - "First Last, MD"
institute: 
  - "USC Keck School of Medicine"
  - "Department of Psychiatry and the Behavioral Sciences"
date: "Psychiatry Grand Rounds `r Sys.Date()`"
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: "assets/css/xaringan-themer.css"
    #css: ["default", "assets/css/xaringan-themer.css", "assets/css/my-theme.css", "assets/css/my-fonts.css"]
    chakra: libs/remark-latest.min.js
    nature:
      highlightStyle: solarized-light #github
      highlightLanguage: ["r", "css", "yaml"]
      highlightLines: true
      countIncrementalSlides: false
      ratio: '16:9'
      navigation: list(click = TRUE)
      slideNumberFormat: '%current%'
      # slideNumberFormat: |
      #   <div class="progress-bar-container">
      #     <div class="progress-bar" style="width: calc(%current% / %total% * 100%);">
      #     </div>
      #   </div>      
      includePresenterNotes: yes
      countdown: 60000
    self_contained: true
    anchor_sections: false
    seal: false
    includes:
      in_header: header.html        
---

```{r setup, include=FALSE}
library(knitr)
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(
  fig.path = "figs/",
  fig.width = 9, 
  fig.height = 3.5,
  fig.retina = 3,
  fig.asp = .5,
  out.width = "100%",
  fig.showtext = TRUE,
  comment = NULL,
  cache = TRUE,
  cache.path = "cache/",
  #include = FALSE,
  echo = FALSE,
  message = FALSE, 
  warning = FALSE,
  hiline = TRUE,
  dev = c("svg", "svglite")
)
```

```{r xaringan-themer}
library(xaringan)
library(xaringanExtra)
library(xaringanBuilder)
library(xaringanthemer)
library(rmarkdown)
library(revealjs)
library(blogdown)
library(dataui)
library(reactable)
library(tidyverse)
library(highcharter)
library(htmlwidgets)
library(widgetframe)
library(crosstalk)
library(manipulateWidget)
library(tibble)
library(svglite)

style_mono_accent(
  base_color = "#690f0d",               # bright red
  inverse_background_color = "#002B36", # dark dark blue
  inverse_header_color = "#31b09e",     # light aqua green
  inverse_text_color = "#FFFFFF",       # white
  title_slide_background_color = "var(--base)",
  # text_font_google = google_font("Sen"),
  # header_font_google = google_font("NATS"),
  text_font_google = google_font("Kelly Slab"),
  #header_font_google = google_font("Oleo Script")
  header_font_google = google_font("Major Mono Display")
)

# for fonts
library(showtext)
font_add_google("Bitter", "Bitter")
showtext_auto()
theme_set(theme_minimal(base_family = "Bitter"))

# for colors
pkg_colors <- c("palmerpenguins" = "#7899d4", 
                "blogdown" = "#f5ab1f", 
                "distill" = "#b74f6f")

```

```{r xaringan-extra, include=FALSE}
xaringanExtra::use_panelset()
xaringanExtra::use_tile_view()
xaringanExtra::use_editable(expires = 1)
xaringanExtra::use_animate_css()
xaringanExtra::use_tachyons()
#xaringanExtra::use_slide_tone()
xaringanExtra::use_scribble()
xaringanExtra::use_webcam()
xaringanExtra::use_clipboard()
htmltools::tagList(
  xaringanExtra::use_clipboard(
    button_text = "<i class=\"fa fa-clipboard\"></i>",
    success_text = "<i class=\"fa fa-check\" style=\"color: #90BE6D\"></i>",
    error_text = "<i class=\"fa fa-times-circle\" style=\"color: #F94144\"></i>"
  ),
  rmarkdown::html_dependency_font_awesome()
)
xaringanExtra::style_panelset_tabs(font_family = "inherit")
xaringanExtra::use_freezeframe()
xaringanExtra::use_fit_screen()
xaringanExtra::use_extra_styles(
  hover_code_line = TRUE,         #<<
  mute_unhighlighted_code = TRUE  #<<
)
xaringanExtra::use_progress_bar(color = "#478ce6", location = "top")
xaringanExtra::use_logo(
  image_url = "https://raw.githubusercontent.com/rstudio/hex-stickers/master/PNG/xaringan.png"
)
```

```{r share-again}
xaringanExtra::use_share_again()
xaringanExtra::style_share_again(
  share_buttons = c("twitter", "instagram")
)
xaringanExtra::embed_xaringan(url = "https://brainworkup.github.io/fighton/", ratio = "16:9")
```

```{r broadcast}
xaringanExtra::use_broadcast()
```


class: title-slide, left, middle
background-image: url("images/chimp.jpg")
background-position: right
background-size: contain
background-color: #7899d4ff

.pull-left[

# `r rmarkdown::metadata$title`

## `r rmarkdown::metadata$subtitle`

### `r rmarkdown::metadata$author`

### `r rmarkdown::metadata$institute`

### `r rmarkdown::metadata$date`
]

---
class: middle, center, inverse

# .big-text[Hello.]

???

So hello- I'm so happy to be invited to join you all today.

---

.bg-washed-green.b--dark-green.ba.bw2.br3.shadow-5.ph4.mt5[
If you cannot explain something in simple terms, you don't understand it.

.tr[
— Richard Feynman
]]

.center[![jerry maguire](images/jerry_maguire.gif)]

---

class: inverse center middle

# 80HD
--

## Adult ADHD

### Child ADHD

---

class: inverse center middle

# 80HD

.pull-left[
![](https://octodex.github.com/images/motherhubbertocat.png)
]

.pull-right[
![](https://octodex.github.com/images/dinotocat.png)
]

---

# Neuropsych Deficits

.left-column[
### Working Memory

### Processing Speed

### Response Variability
]

.right-column[
Remembering things short term memory.
Rate of test taking, rate of speed of information processing.
Reaction time variability/response consistency.

Remembering things short term memory.
Rate of test taking, rate of speed of information processing.
Reaction time variability/response consistency.

Remembering things short term memory.
Rate of test taking, rate of speed of information processing.
Reaction time variability/response consistency.

]

---

### Code Blocks

#### R Code

```{r eval=FALSE}
ggplot(gapminder) +
  aes(x = gdpPercap, y = lifeExp, size = pop, color = country) +
  geom_point() +
  facet_wrap(~year)
```

#### JavaScript

```js
var fun = function lang(l) {
  dateformat.i18n = require('./lang/' + l)
  return true;
}
```

---

layout: true

## Tables

---

exclude: `r if (requireNamespace("tibble", quietly=TRUE)) "false" else "true"`

```{r eval=requireNamespace("tibble", quietly=TRUE)}
tibble::as_tibble(mtcars)
```

---

```{r}
knitr::kable(head(mtcars), format = 'html')
```

---

exclude: `r if (requireNamespace("DT", quietly=TRUE)) "false" else "true"`

```{r eval=requireNamespace("DT", quietly=TRUE)}
DT::datatable(head(mtcars), fillContainer = FALSE, options = list(pageLength = 4))
```

---

layout: true

## Plots

---

```{r plot-example, eval=requireNamespace("ggplot2", quietly=TRUE)}
library(ggplot2)
(g <- ggplot(mpg) + aes(hwy, cty, color = class) + geom_point())
```

---

```{r plot-example-themed, eval=requireNamespace("ggplot2", quietly=TRUE)}
g + xaringanthemer::theme_xaringan(text_font_size = 16, title_font_size = 18) +
  ggtitle("A Plot About Cars")
```

---

### Wide image

![](https://guides.github.com/activities/hello-world/branching.png)

.footnote[Wide images scale to 100% slide width]



class: animated slideInRight fadeOutLeft

# remark.js

You can see an introduction of remark.js from [its homepage](https://remarkjs.com). You should read the [remark.js Wiki](https://github.com/gnab/remark/wiki) at least once to know how to

- create a new slide (Markdown syntax<sup>*</sup> and slide properties);

- format a slide (e.g. text alignment);

- configure the slideshow;

- and use the presentation (keyboard shortcuts).

It is important to be familiar with remark.js before you can understand the options in **xaringan**.

.footnote[[*] It is different with Pandoc's Markdown! It is limited but should be enough for presentation purposes. Come on... You do not need a slide for the Table of Contents! Well, the Markdown support in remark.js [may be improved](https://github.com/gnab/remark/issues/142) in the future.]

---

class: middle left

## Distribution of Scores: Population-level Interpretation

```{r gauss-plot1, fig.cap='Statistical classification of neuropsychological test scores in the general population.', fig.width=4, fig.height=4, out.width = "50%"}
knitr::include_graphics("images/plot_narrow.png", auto_pdf = TRUE)
```

---

class: middle left

## Distribution of Scores: Clinical Interpretation

```{r gauss-plot2, fig.cap='General clinical interpretation of performance for individual test scores and broader neuropsychological domains.', fig.width=4, fig.height=4, out.width = "50%"}
knitr::include_graphics("images/plot_broad.png", auto_pdf = TRUE)
```

---

# Highcharter Drilldown
## z-Scores (M = 0, SD = 1)

```{r}
patient <- "Biggie"
```

```{r drillz-data}
library(readr)
library(dplyr)
neurocog <- read_csv("neurocog.csv")
```

```{r}
library(highcharter)
library(tidyverse)
library(htmlwidgets)
library(widgetframe)
library(crosstalk)
library(manipulateWidget)
colors <-
  c(
    "#058DC7",
    "#50B432",
    "#ED561B",
    "#DDDF00",
    "#24CBE5",
    "#64E572"
# "#FF9655",
# "#FFF263",
# "#6AF9C4"
  )
```

```{r drillz-data-tidy}
ncogz <- neurocog %>%
  group_by(domain) %>%
  summarize(zMean = mean(z)
  )
ncogz <- arrange(ncogz, desc(zMean))

## Level 1
ncogL1statusz <- tibble(
  name = ncogz$domain,
  y = ncogz$zMean,
  drilldown = tolower(name)
  )
ncogL1statusz$y <- round(ncogL1statusz$y, 1)

## Level 2
ncogL2drillz <- lapply(unique(neurocog$domain), function(x_level) {
  ncog2z <- subset(neurocog, neurocog$domain %in% x_level)
  ncog2z <- ncog2z %>%
    group_by(subdomain) %>%
    summarize(zMean = mean(z))
  ncog2z <- arrange(ncog2z, desc(zMean)) ### CHECK
  ncogL2zstatus <- tibble(name = ncog2z$subdomain, y = ncog2z$zMean, drilldown = tolower(paste(x_level, name, sep = "_")))
  list(id = tolower(x_level), type = "column", data = list_parse(ncogL2zstatus))
})

## Level 3
ncogL3drillz <- lapply(unique(neurocog$domain), function(x_level) {
  ncog2z <- subset(neurocog, neurocog$domain %in% x_level)
  lapply(unique(ncog2z$subdomain), function(y_level) {
    ncog3z <- subset(ncog2z, ncog2z$subdomain %in% y_level)
    # ncog3 <- ncog2[ncog2$subdomain == y_level,]
    ncog3z <- ncog3z %>%
      group_by(narrow) %>%
      summarize(zMean = mean(z))
    ncog3z <- arrange(ncog3z, desc(zMean))
    ncogL3zstatus <- tibble(name = ncog3z$narrow, y = ncog3z$zMean, drilldown = tolower(paste(x_level, y_level, name, sep = "_")))
    list(id = tolower(paste(x_level, y_level, sep = "_")), type = "column", data = list_parse(ncogL3zstatus))
  })
}) %>% unlist(recursive = FALSE)

## Level 4
ncogL4drillz <- lapply(unique(neurocog$domain), function(x_level) {
  ncog2z <- subset(neurocog, neurocog$domain %in% x_level)
  # ncog2 <- neurocog[neurocog$domain == x_level,]
  lapply(unique(ncog2z$subdomain), function(y_level) {
    ncog3z <- subset(ncog2z, ncog2z$subdomain %in% y_level)
    # ncog3 <- ncog2[ncog2$subdomain == y_level,]
    lapply(unique(ncog3z$narrow), function(z_level) {
      ncog4z <- subset(ncog3z, ncog3z$narrow %in% z_level)
      # ncog4 <- ncog3[ncog3$narrow == z_level,]
      ncog4z <- ncog4z %>%
        group_by(scale) %>%
        summarize(zMean = mean(z))
      ncog4z <- arrange(ncog4z, desc(zMean))
      ncogL4zstatus <- tibble(name = ncog4z$scale, y = ncog4z$zMean)
      list(id = tolower(paste(x_level, y_level, z_level, sep = "_")), type = "column", data = list_parse2(ncogL4zstatus))
    })
  }) %>% unlist(recursive = FALSE)
}) %>% unlist(recursive = FALSE)
```

```{r drillz-tt, fig.cap='Drilldown Neuropsych Testing zScores', fig.width=12, fig.height=8, fig.retina=3, out.width = "100%"}
ncogL1statusz <- ncogL1statusz %>%
  dplyr::mutate(
    rangez = case_when(
      y >= 2.0 ~ "Exceptionally High",
      y %in% 1.3:1.9 ~ "Above Average",
      y %in% 0.7:1.2 ~ "High-Average",
      y %in% -0.7:0.6 ~ "Average",
      y %in% -1.3:-0.6 ~ "Low-Average",
      y %in% -2.0:-1.4 ~ "Below Average",
      y < -2.0 ~ "Exceptionally Low"
    )
  )
x <- c("Name", "Score", "Range")
y <- c("{point.name}", "{point.y}", "{point.rangez}")
tt <- tooltip_table(x, y)
```

```{r drillz-plot}
p1 <-
  highchart() %>%
    hc_title(text = patient,
             style = list(fontSize = "15px")) %>%
    hc_add_series(
      ncogL1statusz,
      type = "bar",
      name = "Neuropsychological Test Scores",
      hcaes(x = name, y = y, color = colors)
    ) %>%
    hc_xAxis(
      type = "category",
      title = list(text = "Domain"),
      categories = .$name
    ) %>%
    hc_yAxis(
      title = list(text = "z-score"),
      labels = list(format = "{value}")
    ) %>%
    hc_tooltip(
      pointFormat = tt,
      useHTML = TRUE,
      valueDecimals = 1
    ) %>%
    hc_plotOptions(
      series = list(
        colorByPoint = TRUE,
        allowPointSelect = TRUE,
        dataLabels = TRUE
      )
    ) %>%
    hc_drilldown(
      allowPointDrilldown = TRUE,
      series = c(ncogL2drillz, ncogL3drillz, ncogL4drillz)
    )
p1
```

---

# Neuropsych Drilldown: Percentiles

```{r drillp-tidy}
# percentiles
ncog <- neurocog %>%
  group_by(domain) %>%
  summarize(Pct = mean(percentile)
  )

ncog <- arrange(ncog, desc(Pct))

## Level 1
ncogL1status <- tibble(
  name = ncog$domain,
  y = as.integer(ncog$Pct),
  drilldown = tolower(name))
# ncogL1status$y <- as.integer(ncogL1status$y)

## Level 2
ncogL2drill <- lapply(unique(neurocog$domain), function(x_level) {
  ncog2 <- subset(neurocog, neurocog$domain %in% x_level)
  # ncog2 <- neurocog[neurocog$domain == x_level,]
  ncog2 <- ncog2 %>%
    group_by(subdomain) %>%
    summarize(Pct = mean(percentile))
  ncog2 <- arrange(ncog2, desc(Pct)) ### CHECK
  ncogL2status <- tibble(name = ncog2$subdomain, y = ncog2$Pct, drilldown = tolower(paste(x_level, name, sep = "_")))
  list(id = tolower(x_level), type = "column", data = list_parse(ncogL2status))
})

## Level 3
ncogL3drill <- lapply(unique(neurocog$domain), function(x_level) {
  ncog2 <- subset(neurocog, neurocog$domain %in% x_level)
  # ncog2 <- neurocog[neurocog$domain == x_level,]
  lapply(unique(ncog2$subdomain), function(y_level) {
    ncog3 <- subset(ncog2, ncog2$subdomain %in% y_level)
    # ncog3 <- ncog2[ncog2$subdomain == y_level,]
    ncog3 <- ncog3 %>%
      group_by(narrow) %>%
      summarize(Pct = mean(percentile))
    ncog3 <- arrange(ncog3, desc(Pct))
    ncogL3status <- tibble(name = ncog3$narrow, y = ncog3$Pct, drilldown = tolower(paste(x_level, y_level, name, sep = "_")))
    list(id = tolower(paste(x_level, y_level, sep = "_")), type = "column", data = list_parse(ncogL3status))
  })
}) %>% unlist(recursive = FALSE)

## Level 4
ncogL4drill <- lapply(unique(neurocog$domain), function(x_level) {
  ncog2 <- subset(neurocog, neurocog$domain %in% x_level)
  # ncog2 <- neurocog[neurocog$domain == x_level,]
  lapply(unique(ncog2$subdomain), function(y_level) {
    ncog3 <- subset(ncog2, ncog2$subdomain %in% y_level)
    # ncog3 <- ncog2[ncog2$subdomain == y_level,]
    lapply(unique(ncog3$narrow), function(z_level) {
      ncog4 <- subset(ncog3, ncog3$narrow %in% z_level)
      # ncog4 <- ncog3[ncog3$narrow == z_level,]
      ncog4 <- ncog4 %>%
        group_by(scale) %>%
        summarize(Pct = mean(percentile))
      ncog4 <- arrange(ncog4, desc(Pct))
      ncogL4status <- tibble(name = ncog4$scale, y = ncog4$Pct)
      list(id = tolower(paste(x_level, y_level, z_level, sep = "_")), type = "column", data = list_parse2(ncogL4status))
    })
  }) %>% unlist(recursive = FALSE)
}) %>% unlist(recursive = FALSE)
```


```{r drillp-tt, fig.cap='Drilldown neurocog Pct', fig.width=12, fig.height=8, fig.retina=3, out.width = "100%"}
## for Tooltip
ncogL1status <- ncogL1status %>%
  dplyr::mutate(
    rangep = case_when(
      y >= 98 ~ "Exceptionally High",
      y %in% 91:97 ~ "Above Average",
      y %in% 75:90 ~ "High-Average",
      y %in% 25:74 ~ "Average",
      y %in% 9:24 ~ "Low-Average",
      y %in% 2:8 ~ "Below Average",
      y < 2 ~ "Exceptionally Low",
      TRUE ~ as.character(y)
    )
  )
x <- c("Name", "Score", "Range")
y <- c("{point.name}", "{point.y}", "{point.rangep}")
tt <- tooltip_table(x, y)
```

```{r drillp-plot, fig.cap='Drilldown neurocog Pct', fig.width=12, fig.height=8, fig.retina=3, out.width = "100%"}
p2 <- 
  highchart() %>%
  hc_title(text = patient,
           style = list(fontSize = "15px")) %>%
  hc_add_series(
    ncogL1status,
    type = "bar",
    name = "neurocogological Test Scores",
    hcaes(x = name, y = y, color = colors)
  ) %>%
  hc_xAxis(
    type = "category",
    title = list(text = "Domain"),
    categories = .$name
  ) %>%
  hc_yAxis(
    title = list(text = "Percentile"),
    labels = list(format = "{value} ‰")
  ) %>%
  hc_tooltip(
    pointFormat = tt,
    useHTML = TRUE,
    valueDecimals = 0
  ) %>%
  hc_plotOptions(
    series = list(
      colorByPoint = TRUE,
      allowPointSelect = TRUE,
      dataLabels = TRUE
    )
  ) %>%
  hc_drilldown(
    allowPointDrilldown = TRUE,
    series = c(ncogL2drill, ncogL3drill, ncogL4drill)
  )
p2
```

---

class: center, middle

# Thanks!

> When something is important enough, you do it even if the odds are not in your favor.

---

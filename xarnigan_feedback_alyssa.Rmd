---
title: "Alyssa Neuropsychological Evaluation Results"
output:
  xaringan::moon_reader:
    #css: [default, lucy, lucy-fonts]
    css: xaringan-themer.css
    nature:
      slideNumberFormat: "%current%"
      highlightStyle: github
      highlightLines: true
      ratio: 16:9
      countIncrementalSlides: true
      includePresenterNotes: true
    self_contained: true
---
class: middle center

```{r setup, include=FALSE}
library(rmarkdown)
library(revealjs)
library(xaringan)
library(xaringanExtra)
library(xaringanthemer)
library(blogdown)
library(dataui)
library(reactable)
## Import CSV files
library(dplyr)
library(readr)
library(forcats)
library(purrr)
library(highcharter)
library(tidyverse)
library(htmlwidgets)
library(widgetframe)
library(crosstalk)
library(manipulateWidget)
library(tibble)
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(
  fig.width = 9, 
  fig.height = 3.5, 
  fig.retina = 3,
  out.width = "100%",
  cache = FALSE,
  echo = FALSE,
  message = FALSE, 
  warning = FALSE,
  fig.show = TRUE,
  hiline = TRUE
)
```

```{r xaringanExtra}
xaringanExtra::use_xaringan_extra(c("tile_view", "animate_css", "tachyons"))
```

```{r broadcast}
xaringanExtra::use_broadcast()
```

```{r xaringan-slide-tone, eval=F}
xaringanExtra::use_slide_tone()
```

```{r xaringan-scribble}
xaringanExtra::use_scribble()
```

```{r xaringan-panelset}
xaringanExtra::use_panelset()
```

```{r xarnigan-webcam}
xaringanExtra::use_webcam()
```

```{r xaringanExtra-clipboard}
htmltools::tagList(
  xaringanExtra::use_clipboard(
    button_text = "<i class=\"fa fa-clipboard\"></i>",
    success_text = "<i class=\"fa fa-check\" style=\"color: #90BE6D\"></i>",
    error_text = "<i class=\"fa fa-times-circle\" style=\"color: #F94144\"></i>"
  ),
  rmarkdown::html_dependency_font_awesome()
)
```

```{r xarnigan-style-panelset-tabs}
xaringanExtra::style_panelset_tabs(font_family = "inherit")
```

```{r xaringanExtra-freezeframe, echo=FALSE}
xaringanExtra::use_freezeframe()
```

```{r xaringan-fit-screen, echo=FALSE}
xaringanExtra::use_fit_screen()
```

```{r xaringan-extra-styles, echo=FALSE}
xaringanExtra::use_extra_styles(
  hover_code_line = TRUE,         #<<
  mute_unhighlighted_code = TRUE  #<<
)
```

```{r xaringanExtra-progress-bar, echo = FALSE}
xaringanExtra::use_progress_bar(color = "#0051BA", location = "top")
```

```{r xaringan-themer, include=FALSE}
library(xaringanthemer)
style_mono_accent(
  base_color = "#690f0d",               # bright red
  inverse_background_color = "#002B36", # dark dark blue
  inverse_header_color = "#31b09e",     # light aqua green
  inverse_text_color = "#FFFFFF",       # white
  title_slide_background_color = "var(--base)",
  text_font_google = google_font("Sen"),
  header_font_google = google_font("NATS")
)
```

```{r}
patient <- "alyssa"
```

```{r echo = F, include=F}
## Import CSV files
library(tidyverse)
# path to files
data_path <- here::here(patient, "csv")
# get file names of .csv files
files <- dir(data_path, pattern = "*.csv")
# read into env
neuropsych <-
  files %>%
  purrr::set_names() %>%
  purrr::map_df(~ readr::read_csv(file.path(data_path, .)),
         na = c("", "NA", "--", "-"),
         .id = "filename") %>%
  dplyr::filter(!is.na(percentile)) %>%
  dplyr::distinct() %>%
  dplyr::mutate(z = qnorm(percentile/100)) %>%
  dplyr::mutate(domain = forcats::as_factor(domain)) %>%
  dplyr::mutate(subdomain = forcats::as_factor(subdomain)) %>%
  dplyr::mutate(narrow = forcats::as_factor(narrow)) %>%
  dplyr::mutate(verbal = forcats::as_factor(verbal)) %>%
  dplyr::mutate(pass = forcats::as_factor(pass)) %>%
  dplyr::mutate(timed = forcats::as_factor(timed))
```

```{r, make-factors-neurocog}
# Subset neurocognitive data
neurocog <-
  neuropsych %>%
  dplyr::filter(test_type == "npsych_test")
## Create factors
# domain
neurocog <-
  neurocog %>%
  dplyr::group_by(domain, .add = TRUE) %>%
  dplyr::filter(!is.na(percentile)) %>%
  dplyr::mutate(z_mean_dom = mean(z), z_sd_dom = sd(z)) %>%
  dplyr::mutate(pct_mean_dom = mean(percentile), pct_sd_dom = sd(percentile)) %>%
  dplyr::ungroup()
# subdomain
neurocog <-
  neurocog %>%
  dplyr::group_by(subdomain, .add = TRUE) %>%
  dplyr::filter(!is.na(percentile)) %>%
  dplyr::mutate(z_mean_sub = mean(z), z_sd_sub = sd(z)) %>%
  dplyr::mutate(pct_mean_sub = mean(percentile), pct_sd_sub = sd(percentile)) %>%
  dplyr::ungroup()
# narrow
neurocog <-
  neurocog %>%
  dplyr::group_by(narrow, .add = TRUE) %>%
  dplyr::filter(!is.na(percentile)) %>%
  dplyr::mutate(z_mean_narrow = mean(z), z_sd_narrow = sd(z)) %>%
  dplyr::mutate(pct_mean_narrow = mean(percentile), pct_sd_narrow = sd(percentile)) %>%
  dplyr::ungroup()
# verbal
neurocog <-
  neurocog %>%
  dplyr::group_by(verbal, .add = TRUE) %>%
  dplyr::filter(!is.na(percentile)) %>%
  dplyr::mutate(z_mean_verbal = mean(z), z_sd_verbal = sd(z)) %>%
  dplyr::ungroup()
# pass
neurocog <-
  neurocog %>%
  dplyr::group_by(pass, .add = TRUE) %>%
  dplyr::filter(!is.na(percentile)) %>%
  dplyr::mutate(z_mean_pass = mean(z), z_sd_pass = sd(z)) %>%
  dplyr::ungroup()
# timed
neurocog <-
  neurocog %>%
  dplyr::group_by(timed, .add = TRUE) %>%
  dplyr::filter(!is.na(percentile)) %>%
  dplyr::mutate(z_mean_timed = mean(z), z_sd_timed = sd(z)) %>%
  dplyr::ungroup()
```

```{r, make-factors-neurobehav}
# Subset neurocognitive data
neurobehav <-
  neuropsych %>%
  dplyr::filter(test_type != "npsych_test")
## Create factors
# domain
neurobehav <-
  neurobehav %>%
  dplyr::group_by(domain, .add = TRUE) %>%
  dplyr::filter(!is.na(score)) %>%
  dplyr::mutate(z_mean_dom = mean(z), z_sd_dom = sd(z)) %>%
  dplyr::mutate(pct_mean_dom = mean(percentile), pct_sd_dom = sd(percentile)) %>%
  dplyr::ungroup()
# subdomain
neurobehav <-
  neurobehav %>%
  dplyr::group_by(subdomain, .add = TRUE) %>%
  dplyr::filter(!is.na(score)) %>%
  dplyr::mutate(z_mean_sub = mean(z), z_sd_sub = sd(z)) %>%
  dplyr::mutate(pct_mean_sub = mean(percentile), pct_sd_sub = sd(percentile)) %>%
  dplyr::ungroup()
# narrow
neurobehav <-
  neurobehav %>%
  dplyr::group_by(narrow, .add = TRUE) %>%
  dplyr::filter(!is.na(score)) %>%
  dplyr::mutate(z_mean_narrow = mean(z), z_sd_narrow = sd(z)) %>%
  dplyr::mutate(pct_mean_narrow = mean(percentile), pct_sd_narrow = sd(percentile)) %>%
  dplyr::ungroup()
```

# Distribution of Scores: Population-level Interpretation

```{r gauss-plot1, fig.cap='Statistical classification of neuropsychological test scores in the general population.', fig.width=4, fig.height=4, out.width = "50%"}
knitr::include_graphics("plot_narrow.png", auto_pdf = TRUE)
```

---
class: middle center

# Distribution of Scores: Clinical Interpretation

```{r gauss-plot2, fig.cap='General clinical interpretation of performance for individual test scores and broader neuropsychological domains.', fig.width=4, fig.height=4, out.width = "50%"}
knitr::include_graphics("plot_broad.png", auto_pdf = TRUE)
```

---

# Neuropsych Drilldown: z-Scores (M = 0, SD = 1)

```{r}
library(highcharter)
library(tidyverse)
library(htmlwidgets)
library(widgetframe)

colors <-
  c(
    "#058DC7",
    "#50B432",
    "#ED561B",
    "#DDDF00",
    "#24CBE5",
    "#64E572"
  )

# colors <-
#   c(
#     "#058DC7",
#     "#50B432",
#     "#ED561B",
#     "#DDDF00",
#     "#24CBE5",
#     "#64E572",
#     "#FF9655",
#     "#FFF263",
#     "#6AF9C4"
#   )
```

```{r}
# for zscores
ncogz <- neurocog %>%
  group_by(domain) %>%
  summarize(zMean = mean(z)
  )

ncogz <- arrange(ncogz, desc(zMean))

## Level 1
ncogL1statusz <- tibble(
  name = ncogz$domain,
  y = ncogz$zMean,
  drilldown = tolower(name)
  )
ncogL1statusz$y <- round(ncogL1statusz$y, 1)

## Level 2
ncogL2drillz <- lapply(unique(neurocog$domain), function(x_level) {
  ncog2z <- subset(neurocog, neurocog$domain %in% x_level)
  # ncog2z <- neurocog2[neurocog2$domain == x_level,]
  ncog2z <- ncog2z %>%
    group_by(subdomain) %>%
    summarize(zMean = mean(z))
  ncog2z <- arrange(ncog2z, desc(zMean)) ### CHECK
  ncogL2zstatus <- tibble(name = ncog2z$subdomain, y = ncog2z$zMean, drilldown = tolower(paste(x_level, name, sep = "_")))
  list(id = tolower(x_level), type = "column", data = list_parse(ncogL2zstatus))
})

## Level 3
ncogL3drillz <- lapply(unique(neurocog$domain), function(x_level) {
  ncog2z <- subset(neurocog, neurocog$domain %in% x_level)
  # ncog2 <- neurocog[neurocog$domain == x_level,]
  lapply(unique(ncog2z$subdomain), function(y_level) {
    ncog3z <- subset(ncog2z, ncog2z$subdomain %in% y_level)
    # ncog3 <- ncog2[ncog2$subdomain == y_level,]
    ncog3z <- ncog3z %>%
      group_by(narrow) %>%
      summarize(zMean = mean(z))
    ncog3z <- arrange(ncog3z, desc(zMean))
    ncogL3zstatus <- tibble(name = ncog3z$narrow, y = ncog3z$zMean, drilldown = tolower(paste(x_level, y_level, name, sep = "_")))
    list(id = tolower(paste(x_level, y_level, sep = "_")), type = "column", data = list_parse(ncogL3zstatus))
  })
}) %>% unlist(recursive = FALSE)

## Level 4
ncogL4drillz <- lapply(unique(neurocog$domain), function(x_level) {
  ncog2z <- subset(neurocog, neurocog$domain %in% x_level)
  # ncog2 <- neurocog[neurocog$domain == x_level,]
  lapply(unique(ncog2z$subdomain), function(y_level) {
    ncog3z <- subset(ncog2z, ncog2z$subdomain %in% y_level)
    # ncog3 <- ncog2[ncog2$subdomain == y_level,]
    lapply(unique(ncog3z$narrow), function(z_level) {
      ncog4z <- subset(ncog3z, ncog3z$narrow %in% z_level)
      # ncog4 <- ncog3[ncog3$narrow == z_level,]
      ncog4z <- ncog4z %>%
        group_by(scale) %>%
        summarize(zMean = mean(z))
      ncog4z <- arrange(ncog4z, desc(zMean))
      ncogL4zstatus <- tibble(name = ncog4z$scale, y = ncog4z$zMean)
      list(id = tolower(paste(x_level, y_level, z_level, sep = "_")), type = "column", data = list_parse2(ncogL4zstatus))
    })
  }) %>% unlist(recursive = FALSE)
}) %>% unlist(recursive = FALSE)
```

```{r drillz, fig.cap='Drilldown Neuropsych Testing zScores', fig.width=12, fig.height=8, fig.retina=3, out.width = "100%"}
## for Tooltip

ncogL1statusz <- ncogL1statusz %>%
  dplyr::mutate(
    rangez = case_when(
      y >= 2.0 ~ "Exceptionally High",
      y %in% 1.3:1.9 ~ "Above Average",
      y %in% 0.7:1.2 ~ "High-Average",
      y %in% -0.7:0.6 ~ "Average",
      y %in% -1.3:-0.6 ~ "Low-Average",
      y %in% -2.0:-1.4 ~ "Below Average",
      y < -2.0 ~ "Exceptionally Low"
    )
  )

# x <- c("Name", "Score")
# y <- c("{point.name}", "{point.y}")
# tt <- tooltip_table(x, y)

x <- c("Name", "Score", "Range")
y <- c("{point.name}", "{point.y}", "{point.rangez}")
tt <- tooltip_table(x, y)

# Create drilldown bar plot zscores
p1 <-
  highchart() %>%
    hc_title(text = patient,
             style = list(fontSize = "15px")) %>%
    hc_add_series(
      ncogL1statusz,
      type = "bar",
      name = "Neuropsychological Test Scores",
      hcaes(x = name, y = y, color = colors)
    ) %>%
    hc_xAxis(
      type = "category",
      title = list(text = "Domain"),
      categories = .$name
    ) %>%
    hc_yAxis(
      title = list(text = "z-score"),
      labels = list(format = "{value}")
    ) %>%
    hc_tooltip(
      pointFormat = tt,
      useHTML = TRUE,
      valueDecimals = 1
    ) %>%
    hc_plotOptions(
      series = list(
        colorByPoint = TRUE,
        allowPointSelect = TRUE,
        dataLabels = TRUE
      )
    ) %>%
    hc_drilldown(
      allowPointDrilldown = TRUE,
      series = c(ncogL2drillz, ncogL3drillz, ncogL4drillz)
    )
p1
```

---

# Neuropsych Drilldown: Percentiles

```{r}
# percentiles
ncog <- neurocog %>%
  group_by(domain) %>%
  summarize(Pct = mean(percentile)
  )

ncog <- arrange(ncog, desc(Pct))

## Level 1
ncogL1status <- tibble(
  name = ncog$domain,
  y = as.integer(ncog$Pct),
  drilldown = tolower(name))
# ncogL1status$y <- as.integer(ncogL1status$y)

## Level 2
ncogL2drill <- lapply(unique(neurocog$domain), function(x_level) {
  ncog2 <- subset(neurocog, neurocog$domain %in% x_level)
  # ncog2 <- neurocog[neurocog$domain == x_level,]
  ncog2 <- ncog2 %>%
    group_by(subdomain) %>%
    summarize(Pct = mean(percentile))
  ncog2 <- arrange(ncog2, desc(Pct)) ### CHECK
  ncogL2status <- tibble(name = ncog2$subdomain, y = ncog2$Pct, drilldown = tolower(paste(x_level, name, sep = "_")))
  list(id = tolower(x_level), type = "column", data = list_parse(ncogL2status))
})

## Level 3
ncogL3drill <- lapply(unique(neurocog$domain), function(x_level) {
  ncog2 <- subset(neurocog, neurocog$domain %in% x_level)
  # ncog2 <- neurocog[neurocog$domain == x_level,]
  lapply(unique(ncog2$subdomain), function(y_level) {
    ncog3 <- subset(ncog2, ncog2$subdomain %in% y_level)
    # ncog3 <- ncog2[ncog2$subdomain == y_level,]
    ncog3 <- ncog3 %>%
      group_by(narrow) %>%
      summarize(Pct = mean(percentile))
    ncog3 <- arrange(ncog3, desc(Pct))
    ncogL3status <- tibble(name = ncog3$narrow, y = ncog3$Pct, drilldown = tolower(paste(x_level, y_level, name, sep = "_")))
    list(id = tolower(paste(x_level, y_level, sep = "_")), type = "column", data = list_parse(ncogL3status))
  })
}) %>% unlist(recursive = FALSE)

## Level 4
ncogL4drill <- lapply(unique(neurocog$domain), function(x_level) {
  ncog2 <- subset(neurocog, neurocog$domain %in% x_level)
  # ncog2 <- neurocog[neurocog$domain == x_level,]
  lapply(unique(ncog2$subdomain), function(y_level) {
    ncog3 <- subset(ncog2, ncog2$subdomain %in% y_level)
    # ncog3 <- ncog2[ncog2$subdomain == y_level,]
    lapply(unique(ncog3$narrow), function(z_level) {
      ncog4 <- subset(ncog3, ncog3$narrow %in% z_level)
      # ncog4 <- ncog3[ncog3$narrow == z_level,]
      ncog4 <- ncog4 %>%
        group_by(scale) %>%
        summarize(Pct = mean(percentile))
      ncog4 <- arrange(ncog4, desc(Pct))
      ncogL4status <- tibble(name = ncog4$scale, y = ncog4$Pct)
      list(id = tolower(paste(x_level, y_level, z_level, sep = "_")), type = "column", data = list_parse2(ncogL4status))
    })
  }) %>% unlist(recursive = FALSE)
}) %>% unlist(recursive = FALSE)
```


```{r drillp, fig.cap='Drilldown neurocog Pct', fig.width=12, fig.height=8, fig.retina=3, out.width = "100%"}

## for Tooltip
ncogL1status <- ncogL1status %>%
  dplyr::mutate(
    rangep = case_when(
      y >= 98 ~ "Exceptionally High",
      y %in% 91:97 ~ "Above Average",
      y %in% 75:90 ~ "High-Average",
      y %in% 25:74 ~ "Average",
      y %in% 9:24 ~ "Low-Average",
      y %in% 2:8 ~ "Below Average",
      y < 2 ~ "Exceptionally Low",
      TRUE ~ as.character(y)
    )
  )

x <- c("Name", "Score")
y <- c("{point.name}", "{point.y}")
tt <- tooltip_table(x, y)

# x <- c("Name", "Score", "Range")
# y <- c("{point.name}", "{point.y}", "{point.rangep}")
# tt <- tooltip_table(x, y)

# Create drilldown bar plot
p2 <- 
  highchart() %>%
  hc_title(text = patient,
           style = list(fontSize = "15px")) %>%
  hc_add_series(
    ncogL1status,
    type = "bar",
    name = "neurocogological Test Scores",
    hcaes(x = name, y = y, color = colors)
  ) %>%
  hc_xAxis(
    type = "category",
    title = list(text = "Domain"),
    categories = .$name
  ) %>%
  hc_yAxis(
    title = list(text = "Percentile"),
    labels = list(format = "{value} â€°")
  ) %>%
  hc_tooltip(
    pointFormat = tt,
    useHTML = TRUE,
    valueDecimals = 0
  ) %>%
  hc_plotOptions(
    series = list(
      colorByPoint = TRUE,
      allowPointSelect = TRUE,
      dataLabels = TRUE
    )
  ) %>%
  hc_drilldown(
    allowPointDrilldown = TRUE,
    series = c(ncogL2drill, ncogL3drill, ncogL4drill)
  )
p2
```

